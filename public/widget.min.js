"use strict";(()=>{(function(){"use strict";const Y=["image/jpeg","image/png","image/gif","image/webp","application/pdf","text/plain","text/csv","text/markdown","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],v={primaryColor:"#001F54",accentColor:"#3B82F6",animationEnabled:!0,animationCycles:6},C={FREQUENCY_THRESHOLD_DB:-100,FREQUENCY_SCALE_FACTOR:11.7185,FREQUENCY_DIVISOR:24e3,FREQUENCY_SPEED_MULTIPLIER:.5,AMPLITUDE_SCALE:10},x={RIPPLE_CYCLES:3,INITIAL_DELAY:1e3,STAGGER_DELAY:150,CYCLE_PAUSE:500,BOUNCE_DURATION:500};let I=!1;function S(){if(I)return;const p=document.createElement("style");p.textContent=`
      @keyframes lbs-icon-bounce {
        0% { transform: translateY(0) scale(1); }
        20% { transform: translateY(-12px) scale(1.15); }
        40% { transform: translateY(-12px) scale(1.1); }
        60% { transform: translateY(0) scale(1.12); }
        80% { transform: translateY(-4px) scale(1.05); }
        100% { transform: translateY(0) scale(1); }
      }

      .lbs-icon-bouncing {
        animation: lbs-icon-bounce 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) forwards;
      }
    `,document.head.appendChild(p),I=!0}function G(p,e){var r,l;if(!((r=e==null?void 0:e.animationEnabled)!=null?r:v.animationEnabled)){console.log("[Widget] Animation disabled in settings");return}if(!p||p.length===0)return;S();const i=p.map(a=>a.querySelector("svg")).filter(Boolean);if(i.length===0)return;const t=(l=e==null?void 0:e.animationCycles)!=null?l:v.animationCycles;let n=0;console.log("[Widget] Starting animation with",t,"cycles");function s(){if(!(n>=t)&&(i.forEach((a,c)=>{const g=c*x.STAGGER_DELAY;setTimeout(()=>{a.classList.remove("lbs-icon-bouncing"),a.offsetWidth,a.classList.add("lbs-icon-bouncing"),setTimeout(()=>{a.classList.remove("lbs-icon-bouncing")},x.BOUNCE_DURATION)},g)}),n++,n<t)){const a=i.length*x.STAGGER_DELAY+x.BOUNCE_DURATION;setTimeout(s,a+x.CYCLE_PAUSE)}}setTimeout(s,x.INITIAL_DELAY)}function X(p,e){var s,r;if(!((s=e==null?void 0:e.animationEnabled)!=null?s:v.animationEnabled)){console.log("[Widget] Single button animation disabled in settings");return}if(!p)return;S();const i=(r=e==null?void 0:e.animationCycles)!=null?r:v.animationCycles;let t=0;console.log("[Widget] Starting single button animation with",i,"cycles");function n(){t>=i||(p.classList.remove("lbs-icon-bouncing"),p.offsetWidth,p.classList.add("lbs-icon-bouncing"),setTimeout(()=>{p.classList.remove("lbs-icon-bouncing")},x.BOUNCE_DURATION),t++,t<i&&setTimeout(n,x.BOUNCE_DURATION+x.CYCLE_PAUSE))}setTimeout(n,x.INITIAL_DELAY)}function J(p){return Y.includes(p.type)?p.size>52428800?{valid:!1,error:`File too large: ${p.name}. Maximum size is 50MB`}:{valid:!0}:{valid:!1,error:`Unsupported file type: ${p.name}. Supported: PDF, images, text, DOCX, XLSX`}}function Q(p){return new Promise((e,o)=>{const i=new FileReader;i.readAsDataURL(p),i.onload=()=>{if(typeof i.result=="string"){const t=i.result.split(",")[1];e(t)}else o(new Error("Failed to convert file to base64"))},i.onerror=t=>o(t)})}function B(p){if(p===0)return"0 Bytes";const e=1024,o=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(p)/Math.log(e));return parseFloat((p/Math.pow(e,i)).toFixed(2))+" "+o[i]}function T(p){return p==="application/pdf"?"\u{1F4C4}":p.startsWith("image/")?"\u{1F5BC}\uFE0F":p.startsWith("text/")?"\u{1F4DD}":p.includes("spreadsheet")||p.includes("excel")?"\u{1F4CA}":p.includes("word")||p.includes("document")?"\u{1F4C3}":"\u{1F4CE}"}const D=["Thinking...","Processing...","Analyzing...","Considering...","Evaluating...","Pondering...","Contemplating...","Reflecting...","Reasoning...","Deliberating...","Examining...","Assessing...","Reviewing...","Calculating...","Formulating..."];function K(){const p=Math.floor(Math.random()*D.length);return D[p]}function h(p){return p?String(p).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"):""}function M(p,e="error",o=5e3){let i=document.getElementById("lbs-toast-container");i||(i=document.createElement("div"),i.id="lbs-toast-container",i.style.cssText=`
        position: fixed;
        bottom: 100px;
        right: 24px;
        z-index: 10001;
        display: flex;
        flex-direction: column;
        gap: 8px;
        pointer-events: none;
      `,document.body.appendChild(i));const t=document.createElement("div");t.className=`lbs-toast lbs-toast-${e}`;const n=Z(e);t.innerHTML=`
      <div class="lbs-toast-icon">${n}</div>
      <div class="lbs-toast-content">
        <p class="lbs-toast-message">${h(p)}</p>
      </div>
      <button class="lbs-toast-close" aria-label="Close">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    `;const s=t.querySelector(".lbs-toast-close");return s.onclick=()=>z(t),i.appendChild(t),requestAnimationFrame(()=>{t.classList.add("lbs-toast-visible")}),o>0&&setTimeout(()=>z(t),o),t}function z(p){!p||!p.parentNode||(p.classList.remove("lbs-toast-visible"),p.classList.add("lbs-toast-hiding"),setTimeout(()=>{p.parentNode&&p.parentNode.removeChild(p)},200))}function Z(p){switch(p){case"error":return`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="15" y1="9" x2="9" y2="15"></line>
          <line x1="9" y1="9" x2="15" y2="15"></line>
        </svg>`;case"success":return`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>`;case"warning":return`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
          <line x1="12" y1="9" x2="12" y2="13"></line>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>`;default:return`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>`}}function ee(){const p=document.getElementsByTagName("script");for(let e=p.length-1;e>=0;e--){const o=p[e].src;if(o&&/widget(\.min)?\.js(\?|$)/.test(o))try{return new URL(o).origin}catch(i){}}return window.location.origin}const te={apiUrl:ee(),position:"bottom-right",zIndex:9999};function $(p){if(!p)return"";let e=p.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");const o=[];e=e.replace(/```(\w*)\n?([\s\S]*?)```/g,(r,l,a)=>{const c=o.length;return o.push('<pre class="widget-code-block"><code>'+a+"</code></pre>"),`
%%CODEBLOCK_`+c+`%%
`}),e=e.replace(/`([^`]+)`/g,'<code class="widget-inline-code">$1</code>').replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>").replace(/__([^_]+)__/g,"<strong>$1</strong>").replace(/\*([^*]+)\*/g,"<em>$1</em>").replace(/_([^_]+)_/g,"<em>$1</em>").replace(/~~([^~]+)~~/g,"<del>$1</del>").replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer" class="widget-link">$1</a>');const i=e.split(`
`),t=[];let n=!1,s="";for(let r=0;r<i.length;r++){const a=i[r].trim();if(/^%%CODEBLOCK_\d+%%$/.test(a)){n&&(t.push(s==="ul"?"</ul>":"</ol>"),n=!1);const u=parseInt(a.match(/\d+/)[0]);t.push(o[u]);continue}if(/^[-*_]{3,}\s*$/.test(a)){n&&(t.push(s==="ul"?"</ul>":"</ol>"),n=!1),t.push('<hr class="widget-hr">');continue}const c=a.match(/^(#{1,6})\s+(.+)$/);if(c){n&&(t.push(s==="ul"?"</ul>":"</ol>"),n=!1);const u=c[1].length;t.push("<h"+u+' class="widget-heading">'+c[2]+"</h"+u+">");continue}const g=a.match(/^>\s*(.+)$/);if(g){n&&(t.push(s==="ul"?"</ul>":"</ol>"),n=!1),t.push('<blockquote class="widget-blockquote">'+g[1]+"</blockquote>");continue}const b=a.match(/^[-*+]\s+(.+)$/);if(b){(!n||s!=="ul")&&(n&&t.push(s==="ul"?"</ul>":"</ol>"),t.push('<ul class="widget-list">'),n=!0,s="ul"),t.push('<li class="widget-list-item">'+b[1]+"</li>");continue}const d=a.match(/^\d+\.\s+(.+)$/);if(d){(!n||s!=="ol")&&(n&&t.push(s==="ul"?"</ul>":"</ol>"),t.push('<ol class="widget-list-ordered">'),n=!0,s="ol"),t.push('<li class="widget-list-item-ordered">'+d[1]+"</li>");continue}a!==""&&(n&&(t.push(s==="ul"?"</ul>":"</ol>"),n=!1),t.push("<p>"+a+"</p>"))}return n&&t.push(s==="ul"?"</ul>":"</ol>"),e=t.join(""),e}function ie(p){if(!p)return"AI";const e=p.trim().split(/\s+/);return e.length===1?e[0][0].toUpperCase():(e[0][0]+e[e.length-1][0]).toUpperCase()}class oe{constructor(e){this.config={...te,...e},this.isOpen=!1,this.isFullscreen=!1,this.currentView="profile",this.activeBarItem=null,this.chatbot=null,this.isLoading=!1,this.appearance=v,this.bookingConfig=null,this.bookingStep=1,this.bookingData={categoryId:null,categoryName:null,subCategoryId:null,subCategoryName:null,caseDescription:"",firstName:"",lastName:"",email:"",phone:"",locationId:null,locationName:null,locationAddress:null,appointmentDate:null,appointmentTime:null},this.textConfig=null,this.textData={firstName:"",lastName:"",email:"",phone:"",message:""},this.pendingFiles=[],this.dragCounter=0,this.fileError=null,this.isRecording=!1,this.deepgramSocket=null,this.mediaRecorder=null,this.mediaStream=null,this.finalTranscript="",this.interimTranscript="",this.audioContext=null,this.siriWave=null,this.isSidebarOpen=!1,this.initializeConversations(),this.init()}initializeConversations(){const e=`lbs_widget_${this.config.chatbotId}`,o=`lbs_chat_${this.config.chatbotId}`;try{const i=localStorage.getItem(e);if(i){const n=JSON.parse(i);if(n.deviceId&&n.conversations&&n.currentConversationId){this.deviceId=n.deviceId,this.conversations=n.conversations,this.currentConversationId=n.currentConversationId,this.cleanupExpiredConversations();const s=this.getCurrentConversation();if(s){this.sessionId=s.sessionId,this.messages=s.messages||[],this.isNewSession=!1;return}}}const t=localStorage.getItem(o);if(t){const n=JSON.parse(t);if(n.sessionId&&Date.now()<n.expiresAt){const s=n.sessionId,r=this.generateTitleFromMessages(n.messages||[]);this.deviceId=this.generateId(),this.conversations={[s]:{sessionId:s,title:r,createdAt:n.createdAt||Date.now(),lastMessageAt:Date.now(),expiresAt:n.expiresAt,messages:n.messages||[]}},this.currentConversationId=s,this.saveConversations(),localStorage.removeItem(o),this.sessionId=s,this.messages=n.messages||[],this.isNewSession=!1;return}else localStorage.removeItem(o)}this.createNewConversation()}catch(i){console.error("Error initializing conversations:",i),localStorage.removeItem(e),localStorage.removeItem(o),this.createNewConversation()}}getCurrentConversation(){if(!this.currentConversationId||!this.conversations)return null;const e=this.conversations[this.currentConversationId];return e?Date.now()>=e.expiresAt?(this.deleteConversation(this.currentConversationId),null):e:null}createNewConversation(){const e=this.generateId();this.deviceId||(this.deviceId=this.generateId()),this.conversations||(this.conversations={}),this.conversations[e]={sessionId:e,title:"New Chat",createdAt:Date.now(),lastMessageAt:Date.now(),expiresAt:Date.now()+864e5,messages:[]},this.currentConversationId=e,this.sessionId=e,this.messages=[],this.isNewSession=!0,this.saveConversations()}switchConversation(e){const o=this.conversations[e];if(!o){console.error("Conversation not found:",e);return}if(Date.now()>=o.expiresAt){this.deleteConversation(e);return}this.currentConversationId=e,this.sessionId=o.sessionId,this.messages=o.messages||[],this.isNewSession=!1,this.saveConversations(),this.currentView="chat",this.renderCurrentView(),this.isSidebarOpen&&this.toggleSidebar()}showDeleteConfirmationModal(e){const o=document.getElementById("lbs-chat-window");if(!o)return;const i=document.createElement("div");i.id="lbs-delete-modal-overlay",i.style.cssText=`
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.2s ease-out;
        border-radius: 16px;
      `;const t=document.createElement("div");t.style.cssText=`
        background: white;
        border-radius: 12px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        animation: slideIn 0.2s ease-out;
      `,t.innerHTML=`
        <div style="margin-bottom: 16px;">
          <h3 style="font-size: 18px; font-weight: 600; color: #1f2937; margin: 0 0 8px 0;">
            Delete conversation?
          </h3>
          <p style="font-size: 14px; color: #6b7280; margin: 0; line-height: 1.5;">
            This action cannot be undone. This will permanently delete the conversation and all its messages.
          </p>
        </div>
        <div style="display: flex; gap: 8px; justify-content: flex-end;">
          <button id="lbs-delete-cancel" style="
            padding: 8px 16px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
          ">
            Cancel
          </button>
          <button id="lbs-delete-confirm" style="
            padding: 8px 16px;
            background: #ef4444;
            border: 1px solid #ef4444;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
          ">
            Delete
          </button>
        </div>
      `,i.appendChild(t),o.appendChild(i);const n=()=>{i.style.animation="fadeOut 0.2s ease-out",setTimeout(()=>i.remove(),200)},s=t.querySelector("#lbs-delete-cancel");s.onclick=n,s.onmouseover=()=>{s.style.background="#f9fafb"},s.onmouseout=()=>{s.style.background="white"};const r=t.querySelector("#lbs-delete-confirm");r.onclick=()=>{this.deleteConversation(e),this.renderSidebar(),n()},r.onmouseover=()=>{r.style.background="#dc2626"},r.onmouseout=()=>{r.style.background="#ef4444"},i.onclick=l=>{l.target===i&&n()}}deleteConversation(e){if(delete this.conversations[e],this.currentConversationId===e){const o=Object.keys(this.conversations);if(o.length>0){const i=o.sort((t,n)=>this.conversations[n].lastMessageAt-this.conversations[t].lastMessageAt);this.switchConversation(i[0])}else this.createNewConversation(),this.currentView="profile",this.renderCurrentView()}this.saveConversations()}updateConversationTitle(e,o){const i=this.conversations[e];i&&(i.title=o,this.saveConversations())}saveConversations(){const e=`lbs_widget_${this.config.chatbotId}`;try{const o={deviceId:this.deviceId,conversations:this.conversations,currentConversationId:this.currentConversationId};localStorage.setItem(e,JSON.stringify(o))}catch(o){if(console.error("Error saving conversations:",o),o.name==="QuotaExceededError"){const i={deviceId:this.deviceId,conversations:{[this.currentConversationId]:this.conversations[this.currentConversationId]},currentConversationId:this.currentConversationId};localStorage.setItem(e,JSON.stringify(i))}}}updateCurrentConversation(){const e=this.conversations[this.currentConversationId];if(e){if(e.messages=this.messages,e.lastMessageAt=Date.now(),e.title==="New Chat"&&this.messages.length>0){const o=this.messages.find(i=>i.role==="user");o&&(e.title=this.generateTitleFromMessage(o.content))}this.saveConversations()}}generateTitleFromMessage(e){if(!e)return"New Chat";const o=e.replace(/\n+/g," ").replace(/\s+/g," ").trim();return o.length<=50?o:o.slice(0,47)+"..."}generateTitleFromMessages(e){const o=e.find(i=>i.role==="user");return o?this.generateTitleFromMessage(o.content):"New Chat"}cleanupExpiredConversations(){const e=Date.now();let o=!1;for(const[i,t]of Object.entries(this.conversations))if(e>=t.expiresAt&&(delete this.conversations[i],o=!0,i===this.currentConversationId)){const n=Object.keys(this.conversations);n.length>0?this.currentConversationId=n[0]:this.currentConversationId=null}o&&this.saveConversations()}getConversationsList(){return Object.values(this.conversations).sort((e,o)=>o.lastMessageAt-e.lastMessageAt)}toggleSidebar(){this.isSidebarOpen=!this.isSidebarOpen,this.renderSidebar()}renderSidebar(){const e=document.getElementById("lbs-sidebar"),o=document.getElementById("lbs-sidebar-overlay");if(!e||!o)return;this.isSidebarOpen?(e.style.left="0",o.style.display="block"):(e.style.left="-320px",o.style.display="none");const i=this.getConversationsList();e.innerHTML=`
        <div style="display: flex; flex-direction: column; height: 100%; overflow: hidden;">
          <!-- Sidebar Header -->
          <div style="padding: 16px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #111827;">Chat History</h3>
            <button id="lbs-sidebar-close" style="background: none; border: none; cursor: pointer; color: #6b7280; padding: 4px;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>

          <!-- New Conversation Button -->
          <div style="padding: 16px; border-bottom: 1px solid #e5e7eb;">
            <button id="lbs-sidebar-new-btn" style="
              width: 100%;
              padding: 10px 16px;
              background: ${this.appearance.accentColor};
              color: white;
              border: none;
              border-radius: 8px;
              font-size: 14px;
              font-weight: 500;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
              transition: opacity 0.2s;
            ">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="1"></circle>
              </svg>
              New Conversation
            </button>
          </div>

          <!-- Conversation List -->
          <div style="flex: 1; overflow-y: auto; padding: 8px;">
            ${i.length>0?this.renderConversationGroups(i):`
              <div style="padding: 32px 16px; text-align: center; color: #9ca3af;">
                <p style="margin: 0; font-size: 14px;">No conversations yet</p>
              </div>
            `}
          </div>
        </div>
      `;const t=document.getElementById("lbs-sidebar-close"),n=document.getElementById("lbs-sidebar-new-btn");t&&(t.onclick=()=>this.toggleSidebar()),n&&(n.onclick=()=>{this.startNewConversation()},n.onmouseover=()=>{n.style.opacity="0.9"},n.onmouseout=()=>{n.style.opacity="1"}),e.querySelectorAll("[data-conversation-id]").forEach(l=>{const a=l.getAttribute("data-conversation-id");a&&(l.onclick=()=>this.switchConversation(a),l.onmouseover=()=>{a!==this.currentConversationId&&(l.style.background="#f9fafb")},l.onmouseout=()=>{a!==this.currentConversationId&&(l.style.background="white")})}),e.querySelectorAll("[data-delete-conversation]").forEach(l=>{const a=l.getAttribute("data-delete-conversation");a&&(l.onclick=c=>{c.stopPropagation(),this.showDeleteConfirmationModal(a)})})}renderConversationGroups(e){const o=Date.now(),i={Today:[],Yesterday:[],"Last 7 days":[],Older:[]};for(const n of e){const r=(o-n.lastMessageAt)/(1440*60*1e3);r<1?i.Today.push(n):r<2?i.Yesterday.push(n):r<7?i["Last 7 days"].push(n):i.Older.push(n)}let t="";for(const[n,s]of Object.entries(i))s.length>0&&(t+=`
            <div style="margin-bottom: 16px;">
              <h4 style="margin: 0 0 8px 8px; font-size: 12px; font-weight: 500; color: #6b7280; text-transform: uppercase;">
                ${n}
              </h4>
              ${s.map(r=>this.renderConversationItem(r)).join("")}
            </div>
          `);return t}renderConversationItem(e){const o=e.sessionId===this.currentConversationId;return`
        <div
          data-conversation-id="${e.sessionId}"
          style="
            padding: 12px;
            margin-bottom: 4px;
            background: ${o?"#f0f9ff":"white"};
            border: 1px solid ${o?this.appearance.accentColor:"#e5e7eb"};
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: flex-start;
            gap: 8px;
          "
        >
          <div style="flex-shrink: 0; margin-top: 2px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="${o?this.appearance.accentColor:"#9ca3af"}" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
          </div>
          <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px;">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
              <span style="
                font-size: 14px;
                font-weight: ${o?"600":"500"};
                color: ${o?this.appearance.accentColor:"#374151"};
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
              ">
                ${h(e.title)}
              </span>
              ${o?`<span style="padding: 2px 8px; background: ${this.appearance.accentColor}; color: white; font-size: 11px; font-weight: 500; border-radius: 12px; flex-shrink: 0;">Current</span>`:`<button
                      data-delete-conversation="${e.sessionId}"
                      title="Delete conversation"
                      style="
                        flex-shrink: 0;
                        background: none;
                        border: none;
                        cursor: pointer;
                        color: #9ca3af;
                        padding: 2px;
                        display: flex;
                        align-items: center;
                        opacity: 0.7;
                        transition: opacity 0.2s, color 0.2s;
                      "
                      onmouseover="this.style.opacity='1'; this.style.color='#ef4444';"
                      onmouseout="this.style.opacity='0.7'; this.style.color='#9ca3af';"
                    >
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      </svg>
                    </button>`}
            </div>
          </div>
        </div>
      `}formatRelativeTime(e){const i=Date.now()-e,t=Math.floor(i/1e3),n=Math.floor(t/60),s=Math.floor(n/60),r=Math.floor(s/24);if(t<60)return"Just now";if(n<60)return`${n}m ago`;if(s<24)return`${s}h ago`;if(r===1)return"Yesterday";if(r<7)return`${r}d ago`;{const l=new Date(e);return`${l.getMonth()+1}/${l.getDate()}/${l.getFullYear()}`}}startNewConversation(){this.updateCurrentConversation(),this.createNewConversation(),this.currentView="profile",this.renderCurrentView(),this.isSidebarOpen&&this.toggleSidebar()}saveSession(){this.updateCurrentConversation()}generateId(){return Date.now().toString(36)+Math.random().toString(36).substring(2,15)}async init(){try{await this.loadChatbotConfig(),this.createWidget(),this.attachEventListeners()}catch(e){console.error("Failed to initialize chatbot:",e)}}async loadChatbotConfig(){const e=await fetch(`${this.config.apiUrl}/api/public/chat/${this.config.chatbotId}`,{headers:{"ngrok-skip-browser-warning":"true"}});if(!e.ok)throw new Error("Failed to load chatbot configuration");const o=await e.json();if(this.chatbot=o.data,this.chatbot.appearance)try{this.appearance=typeof this.chatbot.appearance=="string"?JSON.parse(this.chatbot.appearance):this.chatbot.appearance}catch(i){console.warn("Failed to parse appearance config:",i),this.appearance=v}if(this.chatbot.bookingConfig)try{this.bookingConfig=typeof this.chatbot.bookingConfig=="string"?JSON.parse(this.chatbot.bookingConfig):this.chatbot.bookingConfig}catch(i){console.warn("Failed to parse booking config:",i),this.bookingConfig=null}if(this.chatbot.textConfig)try{this.textConfig=typeof this.chatbot.textConfig=="string"?JSON.parse(this.chatbot.textConfig):this.chatbot.textConfig}catch(i){console.warn("Failed to parse text config:",i),this.textConfig=null}}isBookingEnabled(){return this.bookingConfig&&this.bookingConfig.enabled===!0&&Array.isArray(this.bookingConfig.categories)&&this.bookingConfig.categories.length>0&&Array.isArray(this.bookingConfig.locations)&&this.bookingConfig.locations.length>0}isTextEnabled(){return this.textConfig&&this.textConfig.enabled===!0}hasMultipleActions(){return this.isBookingEnabled()||this.isTextEnabled()}createWidget(){const e=document.createElement("div");if(e.id="lbs-chat-widget",e.style.cssText=`
        position: fixed;
        ${this.config.position.includes("right")?"right: 20px;":"left: 20px;"}
        bottom: 0;
        z-index: ${this.config.zIndex};
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      `,this.hasMultipleActions()){const i=this.createActionBar();e.appendChild(i)}else{const i=this.createChatButton();e.appendChild(i)}const o=this.createChatWindow();e.appendChild(o),document.body.appendChild(e)}createActionBar(){const e=document.createElement("div");e.id="lbs-action-bar",e.style.cssText=`
        display: flex;
        background: ${this.appearance.primaryColor};
        border-radius: 12px 12px 0 0;
        overflow: visible;
        box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
      `;const o=[];if(this.isBookingEnabled()){const n=this.createActionBarItem("book","Book",`
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11l3 3L22 4"></path>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
          </svg>
        `);e.appendChild(n),o.push(n)}if(this.isTextEnabled()){const n=this.createActionBarItem("text","Text",`
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
          </svg>
        `);e.appendChild(n),o.push(n)}const i=this.createActionBarItem("chat","Chat",`
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
      `);e.appendChild(i),o.push(i),console.log("[Widget] Scheduling animation for",o.length,"items");const t=this.appearance;return setTimeout(()=>{console.log("[Widget] Triggering animation now with config:",t),G(o,t)},100),e}createActionBarItem(e,o,i){const t=document.createElement("button");return t.className="lbs-action-bar-item",t.dataset.action=e,t.innerHTML=`
        ${i}
        <span style="font-size: 12px; font-weight: 500;">${o}</span>
      `,t.style.cssText=`
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 12px 24px;
        color: white;
        background: transparent;
        border: none;
        cursor: pointer;
        gap: 4px;
        transition: background 0.2s;
      `,t.onmouseover=()=>{t.style.background="rgba(255, 255, 255, 0.1)"},t.onmouseout=()=>{this.activeBarItem!==e&&(t.style.background="transparent")},t.onclick=()=>this.handleActionBarClick(e),t}handleActionBarClick(e){var o;if(this.activeBarItem=e,this.updateActionBarActiveState(),e==="book"?this.currentView="booking":e==="text"?this.currentView="text":this.currentView="chat",!this.isOpen){this.isOpen=!0;const i=document.getElementById("lbs-chat-window");i&&(i.style.display="flex")}this.renderCurrentView(),e==="chat"&&this.messages.length===0&&((o=this.chatbot)!=null&&o.chatGreeting)&&setTimeout(()=>{this.renderMessage("assistant",this.chatbot.chatGreeting)},300)}updateActionBarActiveState(){document.querySelectorAll(".lbs-action-bar-item").forEach(o=>{o.dataset.action===this.activeBarItem?o.style.background="rgba(255, 255, 255, 0.2)":o.style.background="transparent"})}createChatButton(){const e=document.createElement("button");e.id="lbs-chat-button",e.innerHTML=`
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
      `,e.style.cssText=`
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: ${this.appearance.primaryColor};
        color: white;
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
        margin-bottom: 20px;
      `,e.onmouseover=()=>{e.style.transform="scale(1.1)"},e.onmouseout=()=>{e.style.transform="scale(1)"},e.onclick=()=>this.toggleChat();const o=this.appearance;return setTimeout(()=>{X(e,o)},100),e}createChatWindow(){const e=document.createElement("div");e.id="lbs-chat-window";const o=this.config.position.includes("right"),i=this.hasMultipleActions(),n=i?`${(i?64:0)+8}px`:"100px",s=`calc(100vh - 650px - ${n})`,r=o?"calc(100vw - 400px - 20px)":"20px",l=o?"20px":"calc(100vw - 400px - 20px)";e.style.cssText=`
        display: none;
        position: fixed;
        top: ${s};
        bottom: ${n};
        left: ${r};
        right: ${l};
        width: 400px;
        height: 650px;
        max-height: calc(100vh - 140px);
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        flex-direction: column;
        overflow: hidden;
        transition: all 0.3s ease-in-out;
      `;const a=document.createElement("div");return a.id="lbs-chat-content",a.style.cssText=`
        width: 100%;
        height: 100%;
        position: relative;
        overflow: hidden;
      `,e.appendChild(a),e}attachEventListeners(){}renderCurrentView(){const e=document.getElementById("lbs-chat-content");e&&(e.style.opacity="0",e.style.transition="opacity 0.2s ease-in-out",setTimeout(()=>{this.currentView==="profile"?(e.innerHTML=this.createProfileView(),this.attachProfileEventListeners()):this.currentView==="booking"?(e.innerHTML=this.createBookingView(),this.attachBookingEventListeners()):this.currentView==="text"?(e.innerHTML=this.createTextView(),this.attachTextEventListeners()):(e.innerHTML=this.createChatView(),this.attachChatEventListeners(),this.renderStoredMessages()),setTimeout(()=>{e.style.opacity="1"},50)},200))}createProfileView(){var t,n,s,r,l,a;const e=ie((t=this.chatbot)==null?void 0:t.name),o=(n=this.chatbot)==null?void 0:n.thumbnail,i=((s=this.chatbot)==null?void 0:s.suggestedQuestions)||[];return`
        <div style="display: flex; flex-direction: column; height: 100%; background: white; align-items: center;">
          <!-- Content container with max-width for fullscreen -->
          <div style="width: 100%; max-width: 600px; display: flex; flex-direction: column; height: 100%;">
            <!-- Header with expand and minimize buttons -->
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px;">
              <div style="width: 24px;"></div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <!-- Expand button (shown in normal mode) -->
                <button id="lbs-expand-btn" title="Expand" style="background: none; border: none; cursor: pointer; color: #6b7280; padding: 4px; display: block;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"></path>
                  </svg>
                </button>
                <!-- Minimize fullscreen button (shown in fullscreen mode) -->
                <button id="lbs-fullscreen-minimize-btn" title="Exit fullscreen" style="background: none; border: none; cursor: pointer; color: #6b7280; padding: 4px; display: none;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path>
                  </svg>
                </button>
                <!-- Close/minimize widget button -->
                <button id="lbs-minimize-btn" title="Minimize" style="background: none; border: none; cursor: pointer; color: #6b7280; padding: 4px;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="18 15 12 9 6 15"></polyline>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Branding -->
            ${(r=this.chatbot)!=null&&r.showBranding?`
            <div style="text-align: center; padding: 4px 12px; background: #f9fafb; border-bottom: 1px solid #f3f4f6;">
              <a href="https://leadbotpartners.com" target="_blank" rel="noopener noreferrer" style="font-size: 10px; color: #9ca3af; text-decoration: none;">Powered by Leadbot Partners</a>
            </div>
            `:""}

            <!-- Profile Section -->
            <div style="display: flex; flex-direction: column; align-items: center; padding: 0 24px 24px;">
            <!-- Avatar -->
            <div style="position: relative; margin-bottom: 16px;">
              ${o?`<img src="${o}" alt="${h(this.chatbot.name)}" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; filter: grayscale(100%);" />`:`<div style="width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, ${this.appearance.primaryColor} 0%, ${this.appearance.accentColor} 100%); display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: 600; color: white;">${e}</div>`}
              <div style="position: absolute; bottom: 8px; right: 8px; width: 20px; height: 20px; background: #10b981; border: 3px solid white; border-radius: 50%;"></div>
            </div>

            <!-- Name and Description -->
            <h2 style="margin: 0 0 4px 0; font-size: 20px; font-weight: 600; color: #111827; text-align: center;">
              ${h(((l=this.chatbot)==null?void 0:l.name)||"AI Assistant")}
            </h2>
            ${(a=this.chatbot)!=null&&a.description?`<p style="margin: 0 0 20px 0; font-size: 14px; color: #6b7280; text-align: center; line-height: 1.5;">${h(this.chatbot.description)}</p>`:""}

            ${this.isBookingEnabled()?`
            <!-- Schedule Appointment Button -->
            <button id="lbs-start-booking-btn" style="
              width: 100%;
              padding: 12px 24px;
              background: ${this.appearance.primaryColor};
              color: white;
              border: none;
              border-radius: 8px;
              font-size: 15px;
              font-weight: 500;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
              transition: background 0.2s;
              margin-bottom: 12px;
            ">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              Schedule Appointment
            </button>
            `:""}

            ${this.isTextEnabled()?`
            <!-- Send us a Text Button -->
            <button id="lbs-start-text-btn" style="
              width: 100%;
              padding: 12px 24px;
              background: ${this.isBookingEnabled()?"white":this.appearance.primaryColor};
              color: ${this.isBookingEnabled()?this.appearance.primaryColor:"white"};
              border: ${this.isBookingEnabled()?"1px solid "+this.appearance.primaryColor:"none"};
              border-radius: 8px;
              font-size: 15px;
              font-weight: 500;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
              transition: background 0.2s;
              margin-bottom: 12px;
            ">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
              </svg>
              Send us a Text
            </button>
            `:""}

            <!-- Chat Button -->
            <button id="lbs-start-chat-btn" style="
              width: 100%;
              padding: 12px 24px;
              background: ${this.isBookingEnabled()||this.isTextEnabled()?"white":this.appearance.accentColor};
              color: ${this.isBookingEnabled()||this.isTextEnabled()?this.appearance.primaryColor:"white"};
              border: ${this.isBookingEnabled()||this.isTextEnabled()?"1px solid "+this.appearance.primaryColor:"none"};
              border-radius: 8px;
              font-size: 15px;
              font-weight: 500;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
              transition: background 0.2s;
            ">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              Chat
            </button>
          </div>

          ${i.length>0?`
            <!-- Suggested Questions -->
            <div style="flex: 1; overflow-y: auto; padding: 0 24px 24px; min-height: 0;">
              <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600; color: #111827;">
                Suggested Questions
              </h3>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                ${i.map((c,g)=>`
                  <button class="suggested-question-btn" data-question="${h(c)}" style="
                    padding: 12px 16px;
                    background: white;
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                    text-align: left;
                    cursor: pointer;
                    transition: all 0.2s;
                    display: flex;
                    align-items: flex-start;
                    gap: 10px;
                    font-size: 14px;
                    color: #374151;
                  ">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0; margin-top: 2px; color: #9ca3af;">
                      <path d="M12 3v18m0 0l-6-6m6 6l6-6"></path>
                    </svg>
                    ${h(c)}
                  </button>
                `).join("")}
              </div>
            </div>
          `:""}
          </div>
        </div>
      `}createChatView(){var e;return`
        <div style="display: flex; flex-direction: column; height: 100%; position: relative;">
          <!-- Sidebar Overlay -->
          <div id="lbs-sidebar-overlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000;"></div>

          <!-- Sidebar -->
          <div id="lbs-sidebar" style="
            position: absolute;
            top: 0;
            left: -320px;
            width: 320px;
            height: 100%;
            background: white;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
            transition: left 0.3s ease-in-out;
            z-index: 1001;
            display: flex;
            flex-direction: column;
          ">
            <!-- Sidebar content will be rendered here -->
          </div>

          <!-- Header -->
          <div style="background: white; padding: 16px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; gap: 8px; align-items: center;">
              <button id="lbs-back-btn" style="background: none; border: none; cursor: pointer; color: #6b7280; padding: 4px; display: flex; align-items: center;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
              </button>
              <button id="lbs-history-btn" title="Chat History" style="background: none; border: none; cursor: pointer; color: #6b7280; padding: 4px; display: flex; align-items: center;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
              </button>
            </div>
            <span style="font-weight: 600; color: #111827; font-size: 15px;">${h(((e=this.chatbot)==null?void 0:e.name)||"Chat")}</span>
            <div style="display: flex; gap: 8px; align-items: center;">
              <!-- Expand button (shown in normal mode) -->
              <button id="lbs-expand-btn" title="Expand" style="background: none; border: none; cursor: pointer; color: #6b7280; padding: 4px; display: block;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"></path>
                </svg>
              </button>
              <!-- Minimize fullscreen button (shown in fullscreen mode) -->
              <button id="lbs-fullscreen-minimize-btn" title="Exit fullscreen" style="background: none; border: none; cursor: pointer; color: #6b7280; padding: 4px; display: none;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path>
                </svg>
              </button>
              <!-- New conversation button -->
              <button id="lbs-chat-new" title="New Conversation" style="background: none; border: none; cursor: pointer; color: #6b7280; padding: 4px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
            </div>
          </div>

          <!-- Messages area -->
          <div id="lbs-chat-messages" style="
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #f9fafb;
          "></div>

          <!-- Drag overlay -->
          <div id="lbs-drag-overlay" style="display: none;"></div>

          <!-- Input area -->
          <div id="lbs-input-area" style="
            border-top: 1px solid #e5e7eb;
            background: white;
            padding: 16px;
          ">
            <div id="lbs-pending-files" style="display: none;"></div>
            <div id="lbs-file-error" style="display: none;"></div>
            <!-- Unified Input Bar -->
            <div style="display: flex; gap: 12px; padding: 8px 16px; align-items: flex-end; background: white; border: 1px solid #d1d5db; border-radius: 12px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: box-shadow 0.2s;">
              <input type="file" id="lbs-file-input" multiple accept=".pdf,.jpg,.jpeg,.png,.gif,.webp,.txt,.md,.csv,.docx,.xlsx" style="display: none;" />
              <button id="lbs-file-button" title="Attach files" style="
                padding: 8px;
                background: none;
                border: none;
                border-radius: 9999px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #6b7280;
                transition: background 0.2s;
                flex-shrink: 0;
                margin-bottom: 4px;
              ">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                </svg>
              </button>
              <textarea
                id="lbs-chat-input"
                placeholder="Type..."
                rows="1"
                style="
                  width: 100%;
                  flex: 1;
                  padding: 8px 0;
                  border: none;
                  background: transparent;
                  font-size: 14px;
                  font-family: inherit;
                  resize: none;
                  min-height: 40px;
                  max-height: 112px;
                  overflow-y: auto;
                  line-height: 1.5;
                  box-sizing: border-box;
                  outline: none;
                "
              ></textarea>
              <button
                id="lbs-chat-send-mic"
                title="Send message"
                style="
                  padding: 8px;
                  background: none;
                  border: none;
                  border-radius: 9999px;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: #6b7280;
                  transition: all 0.2s;
                  flex-shrink: 0;
                  margin-bottom: 4px;
                "
              >
                <svg id="lbs-mic-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                  <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                  <line x1="12" y1="19" x2="12" y2="23"></line>
                  <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
                <svg id="lbs-send-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
              <button id="lbs-menu-button" title="More options" style="
                padding: 8px;
                background: none;
                border: none;
                border-radius: 9999px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #6b7280;
                transition: background 0.2s;
                flex-shrink: 0;
                margin-bottom: 4px;
              ">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="1"></circle>
                  <circle cx="12" cy="5" r="1"></circle>
                  <circle cx="12" cy="19" r="1"></circle>
                </svg>
              </button>
            </div>
          </div>
        </div>
      `}attachProfileEventListeners(){const e=document.getElementById("lbs-minimize-btn"),o=document.getElementById("lbs-expand-btn"),i=document.getElementById("lbs-fullscreen-minimize-btn"),t=document.getElementById("lbs-start-chat-btn"),n=document.getElementById("lbs-start-booking-btn"),s=document.getElementById("lbs-start-text-btn"),r=document.querySelectorAll(".suggested-question-btn");if(e&&(e.onclick=()=>this.toggleChat()),o&&(o.onclick=()=>this.toggleFullscreen()),i&&(i.onclick=()=>this.toggleFullscreen()),n&&(n.onclick=()=>{this.bookingStep=1,this.bookingData={categoryId:null,categoryName:null,subCategoryId:null,subCategoryName:null,caseDescription:"",firstName:"",lastName:"",email:"",phone:"",locationId:null,locationName:null,locationAddress:null,appointmentDate:null,appointmentTime:null},this.currentView="booking",this.renderCurrentView()},n.onmouseover=()=>{n.style.background=this.lightenColor(this.appearance.primaryColor,10)},n.onmouseout=()=>{n.style.background=this.appearance.primaryColor}),s){s.onclick=()=>{this.textData={firstName:"",lastName:"",email:"",phone:"",message:""},this.currentView="text",this.renderCurrentView()};const l=this.isBookingEnabled();s.onmouseover=()=>{l?s.style.background="#f9fafb":s.style.background=this.lightenColor(this.appearance.primaryColor,10)},s.onmouseout=()=>{l?s.style.background="white":s.style.background=this.appearance.primaryColor}}if(t){t.onclick=()=>{var a;this.currentView="chat",this.renderCurrentView(),this.messages.length===0&&((a=this.chatbot)!=null&&a.chatGreeting)&&setTimeout(()=>{this.renderMessage("assistant",this.chatbot.chatGreeting)},300)};const l=this.isBookingEnabled()||this.isTextEnabled();t.onmouseover=()=>{l?t.style.background="#f9fafb":t.style.background=this.lightenColor(this.appearance.accentColor,10)},t.onmouseout=()=>{l?t.style.background="white":t.style.background=this.appearance.accentColor}}r.forEach(l=>{l.onclick=()=>{const a=l.getAttribute("data-question");this.currentView="chat",this.renderCurrentView(),setTimeout(()=>{var g;this.messages.length===0&&((g=this.chatbot)!=null&&g.chatGreeting)&&this.renderMessage("assistant",this.chatbot.chatGreeting);const c=document.getElementById("lbs-chat-input");c&&(c.value=a,c.focus())},300)},l.onmouseover=()=>{l.style.background="#f9fafb",l.style.borderColor=this.appearance.accentColor},l.onmouseout=()=>{l.style.background="white",l.style.borderColor="#e5e7eb"}})}createBookingView(){var s;const o={1:"What can we help you with?",2:"Select a specific service",3:"Tell us about your case",4:"Your contact information",5:"Select a location",6:"Choose date and time",7:"Confirm your appointment"}[this.bookingStep]||"Schedule Appointment",i=((s=this.bookingConfig)==null?void 0:s.requireCaseDescription)!==!1?7:6;let t="";if(this.bookingStep===1)t=this.bookingConfig.categories.map(r=>`
          <button class="booking-category-btn" data-category-id="${h(r.id)}" data-category-name="${h(r.name)}" data-has-subcategories="${r.subCategories&&r.subCategories.length>0?"true":"false"}" style="
            width: 100%;
            padding: 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 15px;
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: space-between;
          ">
            <span>${h(r.name)}</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #9ca3af;">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
        `).join("");else if(this.bookingStep===2){const r=this.bookingConfig.categories.find(a=>a.id===this.bookingData.categoryId);t=((r==null?void 0:r.subCategories)||[]).map(a=>`
          <button class="booking-subcategory-btn" data-subcategory-id="${h(a.id)}" data-subcategory-name="${h(a.name)}" style="
            width: 100%;
            padding: 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 15px;
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: space-between;
          ">
            <span>${h(a.name)}</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #9ca3af;">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
        `).join("")}else if(this.bookingStep===3)t=`
          <div style="space-y: 4;">
            <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">
              Please describe your situation (optional)
            </label>
            <textarea id="booking-case-description" rows="4" placeholder="Briefly describe what brings you in today..." style="
              width: 100%;
              padding: 12px;
              border: 1px solid #d1d5db;
              border-radius: 8px;
              font-size: 14px;
              resize: none;
              box-sizing: border-box;
            ">${h(this.bookingData.caseDescription)}</textarea>
          </div>
        `;else if(this.bookingStep===4)t=`
          <div style="display: flex; flex-direction: column; gap: 16px;">
            <div style="display: flex; gap: 12px;">
              <div style="flex: 1;">
                <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">First Name *</label>
                <input type="text" id="booking-first-name" value="${h(this.bookingData.firstName)}" placeholder="John" style="
                  width: 100%;
                  padding: 12px;
                  border: 1px solid #d1d5db;
                  border-radius: 8px;
                  font-size: 14px;
                  box-sizing: border-box;
                " />
              </div>
              <div style="flex: 1;">
                <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">Last Name *</label>
                <input type="text" id="booking-last-name" value="${h(this.bookingData.lastName)}" placeholder="Doe" style="
                  width: 100%;
                  padding: 12px;
                  border: 1px solid #d1d5db;
                  border-radius: 8px;
                  font-size: 14px;
                  box-sizing: border-box;
                " />
              </div>
            </div>
            <div>
              <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">Email *</label>
              <input type="email" id="booking-email" value="${h(this.bookingData.email)}" placeholder="john@example.com" style="
                width: 100%;
                padding: 12px;
                border: 1px solid #d1d5db;
                border-radius: 8px;
                font-size: 14px;
                box-sizing: border-box;
              " />
            </div>
            <div>
              <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">Phone *</label>
              <input type="tel" id="booking-phone" value="${h(this.bookingData.phone)}" placeholder="(555) 123-4567" style="
                width: 100%;
                padding: 12px;
                border: 1px solid #d1d5db;
                border-radius: 8px;
                font-size: 14px;
                box-sizing: border-box;
              " />
            </div>
          </div>
        `;else if(this.bookingStep===5)t=this.bookingConfig.locations.map(r=>`
          <button class="booking-location-btn" data-location-id="${h(r.id)}" data-location-name="${h(r.name)}" data-location-address="${h(r.address)}" style="
            width: 100%;
            padding: 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
          ">
            <div style="font-size: 15px; font-weight: 500; color: #374151;">${h(r.name)}</div>
            <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">${h(r.address)}</div>
          </button>
        `).join("");else if(this.bookingStep===6){const r=this.bookingConfig.locations.find(b=>b.id===this.bookingData.locationId),l=(r==null?void 0:r.availableDays)||[],a=(r==null?void 0:r.timeSlots)||[],c=[],g=new Date;for(let b=1;b<=30&&c.length<14;b++){const d=new Date(g);d.setDate(g.getDate()+b);const u=d.toLocaleDateString("en-US",{weekday:"long"}).toLowerCase();l.includes(u)&&c.push(d)}t=`
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Select Date *</label>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              ${c.map(b=>{const d=b.toISOString().split("T")[0],u=this.bookingData.appointmentDate===d;return`
                    <button class="booking-date-btn" data-date="${d}" style="
                      padding: 10px 14px;
                      background: ${u?this.appearance.primaryColor:"white"};
                      color: ${u?"white":"#374151"};
                      border: 1px solid ${u?this.appearance.primaryColor:"#e5e7eb"};
                      border-radius: 8px;
                      cursor: pointer;
                      font-size: 13px;
                      transition: all 0.2s;
                    ">
                      <div style="font-weight: 500;">${b.toLocaleDateString("en-US",{weekday:"short"})}</div>
                      <div>${b.toLocaleDateString("en-US",{month:"short",day:"numeric"})}</div>
                    </button>
                  `}).join("")}
            </div>
          </div>
          ${this.bookingData.appointmentDate?`
          <div>
            <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Select Time *</label>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              ${a.map(b=>{const d=this.bookingData.appointmentTime===b.start;return`
                    <button class="booking-time-btn" data-time="${h(b.start)}" style="
                      padding: 10px 16px;
                      background: ${d?this.appearance.primaryColor:"white"};
                      color: ${d?"white":"#374151"};
                      border: 1px solid ${d?this.appearance.primaryColor:"#e5e7eb"};
                      border-radius: 8px;
                      cursor: pointer;
                      font-size: 14px;
                      transition: all 0.2s;
                    ">
                      ${h(b.start)}
                    </button>
                  `}).join("")}
            </div>
          </div>
          `:""}
        `}else if(this.bookingStep===7){const r=this.bookingData.appointmentDate?new Date(this.bookingData.appointmentDate+"T12:00:00").toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}):"";t=`
          <div style="background: #f9fafb; border-radius: 12px; padding: 20px;">
            <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600; color: #111827;">Appointment Details</h4>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #6b7280; font-size: 14px;">Service:</span>
                <span style="color: #111827; font-size: 14px; font-weight: 500;">${h(this.bookingData.categoryName)}${this.bookingData.subCategoryName?" - "+h(this.bookingData.subCategoryName):""}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #6b7280; font-size: 14px;">Location:</span>
                <span style="color: #111827; font-size: 14px; font-weight: 500;">${h(this.bookingData.locationName)}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #6b7280; font-size: 14px;">Date:</span>
                <span style="color: #111827; font-size: 14px; font-weight: 500;">${r}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #6b7280; font-size: 14px;">Time:</span>
                <span style="color: #111827; font-size: 14px; font-weight: 500;">${h(this.bookingData.appointmentTime)}</span>
              </div>
              <div style="border-top: 1px solid #e5e7eb; padding-top: 12px; margin-top: 4px;">
                <span style="color: #6b7280; font-size: 14px;">Contact:</span>
                <div style="color: #111827; font-size: 14px; margin-top: 4px;">
                  ${h(this.bookingData.firstName)} ${h(this.bookingData.lastName)}<br/>
                  ${h(this.bookingData.email)}<br/>
                  ${h(this.bookingData.phone)}
                </div>
              </div>
            </div>
          </div>
        `}return`
        <div style="display: flex; flex-direction: column; height: 100%; background: white;">
          <!-- Header -->
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid #e5e7eb;">
            <button id="booking-back-btn" style="background: none; border: none; cursor: pointer; color: #6b7280; padding: 4px; display: flex; align-items: center;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </button>
            <span style="font-weight: 600; color: #111827; font-size: 15px;">Schedule Appointment</span>
            <button id="booking-close-btn" style="background: none; border: none; cursor: pointer; color: #6b7280; padding: 4px;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>

          <!-- Progress -->
          <div style="display: flex; justify-content: center; gap: 6px; padding: 12px;">
            ${Array.from({length:i},(r,l)=>{const a=l+1,c=a===this.bookingStep,g=a<this.bookingStep;return`<div style="width: 8px; height: 8px; border-radius: 50%; background: ${c||g?this.appearance.primaryColor:"#e5e7eb"};"></div>`}).join("")}
          </div>

          <!-- Step Title -->
          <div style="padding: 0 24px 16px;">
            <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #111827;">${o}</h3>
          </div>

          <!-- Step Content -->
          <div id="booking-step-content" style="flex: 1; overflow-y: auto; padding: 0 24px 24px;">
            <div style="display: flex; flex-direction: column; gap: 12px;">
              ${t}
            </div>
          </div>

          <!-- Footer with Next button (for steps that need it) -->
          ${[3,4,6,7].includes(this.bookingStep)?`
          <div style="padding: 16px 24px; border-top: 1px solid #e5e7eb;">
            <button id="booking-next-btn" style="
              width: 100%;
              padding: 14px 24px;
              background: ${this.appearance.primaryColor};
              color: white;
              border: none;
              border-radius: 8px;
              font-size: 15px;
              font-weight: 500;
              cursor: pointer;
              transition: background 0.2s;
            ">
              ${this.bookingStep===7?"Confirm Booking":"Continue"}
            </button>
            <div id="booking-error" style="display: none; color: #dc2626; font-size: 13px; text-align: center; margin-top: 8px;"></div>
          </div>
          `:""}
        </div>
      `}attachBookingEventListeners(){const e=document.getElementById("booking-back-btn"),o=document.getElementById("booking-close-btn"),i=document.getElementById("booking-next-btn");e&&(e.onclick=()=>{var t,n,s;if(this.bookingStep===1)this.currentView="profile",this.renderCurrentView();else{if(this.bookingStep===3&&!this.bookingData.subCategoryId){const r=this.bookingConfig.categories.find(l=>l.id===this.bookingData.categoryId);(t=r==null?void 0:r.subCategories)!=null&&t.length?this.bookingStep=2:this.bookingStep=1}else if(this.bookingStep===4&&((n=this.bookingConfig)==null?void 0:n.requireCaseDescription)===!1){const r=this.bookingConfig.categories.find(l=>l.id===this.bookingData.categoryId);(s=r==null?void 0:r.subCategories)!=null&&s.length?this.bookingStep=2:this.bookingStep=1}else this.bookingStep--;this.renderCurrentView()}}),o&&(o.onclick=()=>{this.currentView="profile",this.renderCurrentView()}),document.querySelectorAll(".booking-category-btn").forEach(t=>{t.onclick=()=>{var s;this.bookingData.categoryId=t.getAttribute("data-category-id"),this.bookingData.categoryName=t.getAttribute("data-category-name"),t.getAttribute("data-has-subcategories")==="true"?this.bookingStep=2:(this.bookingData.subCategoryId=null,this.bookingData.subCategoryName=null,this.bookingStep=((s=this.bookingConfig)==null?void 0:s.requireCaseDescription)!==!1?3:4),this.renderCurrentView()},t.onmouseover=()=>{t.style.borderColor=this.appearance.primaryColor,t.style.background="#f9fafb"},t.onmouseout=()=>{t.style.borderColor="#e5e7eb",t.style.background="white"}}),document.querySelectorAll(".booking-subcategory-btn").forEach(t=>{t.onclick=()=>{var n;this.bookingData.subCategoryId=t.getAttribute("data-subcategory-id"),this.bookingData.subCategoryName=t.getAttribute("data-subcategory-name"),this.bookingStep=((n=this.bookingConfig)==null?void 0:n.requireCaseDescription)!==!1?3:4,this.renderCurrentView()},t.onmouseover=()=>{t.style.borderColor=this.appearance.primaryColor,t.style.background="#f9fafb"},t.onmouseout=()=>{t.style.borderColor="#e5e7eb",t.style.background="white"}}),document.querySelectorAll(".booking-location-btn").forEach(t=>{t.onclick=()=>{this.bookingData.locationId=t.getAttribute("data-location-id"),this.bookingData.locationName=t.getAttribute("data-location-name"),this.bookingData.locationAddress=t.getAttribute("data-location-address"),this.bookingStep=6,this.renderCurrentView()},t.onmouseover=()=>{t.style.borderColor=this.appearance.primaryColor,t.style.background="#f9fafb"},t.onmouseout=()=>{t.style.borderColor="#e5e7eb",t.style.background="white"}}),document.querySelectorAll(".booking-date-btn").forEach(t=>{t.onclick=()=>{this.bookingData.appointmentDate=t.getAttribute("data-date"),this.bookingData.appointmentTime=null,this.renderCurrentView()}}),document.querySelectorAll(".booking-time-btn").forEach(t=>{t.onclick=()=>{this.bookingData.appointmentTime=t.getAttribute("data-time"),this.renderCurrentView()}}),i&&(i.onclick=async()=>{var n,s,r,l,a,c,g,b;const t=document.getElementById("booking-error");if(t&&(t.style.display="none"),this.bookingStep===3){const d=document.getElementById("booking-case-description");d&&(this.bookingData.caseDescription=d.value),this.bookingStep=4,this.renderCurrentView()}else if(this.bookingStep===4){const d=(s=(n=document.getElementById("booking-first-name"))==null?void 0:n.value)==null?void 0:s.trim(),u=(l=(r=document.getElementById("booking-last-name"))==null?void 0:r.value)==null?void 0:l.trim(),m=(c=(a=document.getElementById("booking-email"))==null?void 0:a.value)==null?void 0:c.trim(),y=(b=(g=document.getElementById("booking-phone"))==null?void 0:g.value)==null?void 0:b.trim();if(!d||!u||!m||!y){t&&(t.textContent="Please fill in all required fields.",t.style.display="block");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(m)){t&&(t.textContent="Please enter a valid email address.",t.style.display="block");return}this.bookingData.firstName=d,this.bookingData.lastName=u,this.bookingData.email=m,this.bookingData.phone=y,this.bookingStep=5,this.renderCurrentView()}else if(this.bookingStep===6){if(!this.bookingData.appointmentDate||!this.bookingData.appointmentTime){t&&(t.textContent="Please select both date and time.",t.style.display="block");return}this.bookingStep=7,this.renderCurrentView()}else this.bookingStep===7&&await this.submitBooking()},i.onmouseover=()=>{i.style.background=this.lightenColor(this.appearance.primaryColor,10)},i.onmouseout=()=>{i.style.background=this.appearance.primaryColor})}async submitBooking(){const e=document.getElementById("booking-next-btn"),o=document.getElementById("booking-error");e&&(e.disabled=!0,e.textContent="Submitting...");try{if(!(await fetch(`${this.config.apiUrl}/api/public/chatbots/${this.config.chatbotId}/bookings`,{method:"POST",headers:{"Content-Type":"application/json","ngrok-skip-browser-warning":"true"},body:JSON.stringify({sessionId:this.sessionId||this.generateId(),categoryId:this.bookingData.categoryId,categoryName:this.bookingData.categoryName,subCategoryId:this.bookingData.subCategoryId,subCategoryName:this.bookingData.subCategoryName,caseDescription:this.bookingData.caseDescription,firstName:this.bookingData.firstName,lastName:this.bookingData.lastName,email:this.bookingData.email,phone:this.bookingData.phone,locationId:this.bookingData.locationId,locationName:this.bookingData.locationName,locationAddress:this.bookingData.locationAddress,appointmentDate:this.bookingData.appointmentDate,appointmentTime:this.bookingData.appointmentTime})})).ok)throw new Error("Failed to submit booking");this.showBookingSuccess()}catch(i){console.error("Booking submission error:",i),o&&(o.textContent="Failed to submit booking. Please try again.",o.style.display="block"),e&&(e.disabled=!1,e.textContent="Confirm Booking")}}showBookingSuccess(){const e=document.getElementById("lbs-chat-content");if(!e)return;const o=this.bookingData.appointmentDate?new Date(this.bookingData.appointmentDate+"T12:00:00").toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}):"";e.innerHTML=`
        <div style="display: flex; flex-direction: column; height: 100%; background: white; align-items: center; justify-content: center; padding: 24px; text-align: center;">
          <div style="width: 80px; height: 80px; background: #d1fae5; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 24px;">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="3">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>
          <h2 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 600; color: #111827;">Appointment Booked!</h2>
          <p style="margin: 0 0 24px 0; font-size: 15px; color: #6b7280; line-height: 1.5;">
            Your appointment has been scheduled. You'll receive a confirmation email shortly.
          </p>
          <div style="background: #f9fafb; border-radius: 12px; padding: 20px; width: 100%; max-width: 300px; text-align: left;">
            <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">
              <strong style="color: #111827;">${o}</strong> at <strong style="color: #111827;">${h(this.bookingData.appointmentTime)}</strong>
            </div>
            <div style="font-size: 14px; color: #6b7280;">
              ${h(this.bookingData.locationName)}
            </div>
          </div>
          <button id="booking-done-btn" style="
            margin-top: 24px;
            padding: 12px 32px;
            background: ${this.appearance.primaryColor};
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
          ">
            Done
          </button>
        </div>
      `;const i=document.getElementById("booking-done-btn");i&&(i.onclick=()=>{this.currentView="profile",this.renderCurrentView()})}createTextView(){var a,c,g,b,d,u,m,y;const e=((a=this.textConfig)==null?void 0:a.fields)||{},o=((c=this.textConfig)==null?void 0:c.consentText)||"By submitting this form, you consent to receive text messages from us. Message and data rates may apply.",i=((g=e.firstName)==null?void 0:g.required)!==!1,t=((b=e.lastName)==null?void 0:b.required)!==!1,n=((d=e.phone)==null?void 0:d.required)!==!1,s=((u=e.email)==null?void 0:u.enabled)!==!1,r=((m=e.email)==null?void 0:m.required)===!0,l=((y=e.message)==null?void 0:y.required)!==!1;return`
        <div style="display: flex; flex-direction: column; height: 100%; background: white;">
          <!-- Header -->
          <div style="padding: 16px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
            <button id="text-back-btn" style="background: none; border: none; cursor: pointer; color: #6b7280; padding: 4px; display: flex; align-items: center;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </button>
            <span style="font-weight: 600; color: #111827; font-size: 15px;">Send us a Text</span>
            <button id="text-close-btn" style="background: none; border: none; cursor: pointer; color: #6b7280; padding: 4px;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>

          <!-- Form Content -->
          <div style="flex: 1; overflow-y: auto; padding: 24px;">
            <div style="display: flex; flex-direction: column; gap: 16px;">
              <!-- First Name and Last Name -->
              <div style="display: flex; gap: 12px;">
                <div style="flex: 1;">
                  <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">First Name${i?" *":""}</label>
                  <input type="text" id="text-first-name" value="${h(this.textData.firstName)}" placeholder="John" style="
                    width: 100%;
                    padding: 12px;
                    border: 1px solid #d1d5db;
                    border-radius: 8px;
                    font-size: 14px;
                    box-sizing: border-box;
                  " />
                </div>
                <div style="flex: 1;">
                  <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">Last Name${t?" *":""}</label>
                  <input type="text" id="text-last-name" value="${h(this.textData.lastName)}" placeholder="Doe" style="
                    width: 100%;
                    padding: 12px;
                    border: 1px solid #d1d5db;
                    border-radius: 8px;
                    font-size: 14px;
                    box-sizing: border-box;
                  " />
                </div>
              </div>

              <!-- Phone -->
              <div>
                <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">Phone Number${n?" *":""}</label>
                <input type="tel" id="text-phone" value="${h(this.textData.phone)}" placeholder="(555) 123-4567" style="
                  width: 100%;
                  padding: 12px;
                  border: 1px solid #d1d5db;
                  border-radius: 8px;
                  font-size: 14px;
                  box-sizing: border-box;
                " />
              </div>

              ${s?`
              <!-- Email -->
              <div>
                <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">Email${r?" *":""}</label>
                <input type="email" id="text-email" value="${h(this.textData.email)}" placeholder="john@example.com" style="
                  width: 100%;
                  padding: 12px;
                  border: 1px solid #d1d5db;
                  border-radius: 8px;
                  font-size: 14px;
                  box-sizing: border-box;
                " />
              </div>
              `:""}

              <!-- Message -->
              <div>
                <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">Message${l?" *":""}</label>
                <textarea id="text-message" rows="4" placeholder="How can we help you?" style="
                  width: 100%;
                  padding: 12px;
                  border: 1px solid #d1d5db;
                  border-radius: 8px;
                  font-size: 14px;
                  resize: none;
                  box-sizing: border-box;
                ">${h(this.textData.message)}</textarea>
              </div>

              <!-- Consent Text -->
              <p style="font-size: 12px; color: #6b7280; line-height: 1.5; margin: 0;">
                ${h(o)}
              </p>

              <!-- Error Message -->
              <div id="text-error" style="display: none; padding: 12px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #dc2626; font-size: 14px;"></div>
            </div>
          </div>

          <!-- Submit Button -->
          <div style="padding: 16px; border-top: 1px solid #e5e7eb;">
            <button id="text-submit-btn" style="
              width: 100%;
              padding: 12px 24px;
              background: ${this.appearance.primaryColor};
              color: white;
              border: none;
              border-radius: 8px;
              font-size: 15px;
              font-weight: 500;
              cursor: pointer;
              transition: background 0.2s;
            ">
              Send Message
            </button>
          </div>
        </div>
      `}attachTextEventListeners(){const e=document.getElementById("text-back-btn"),o=document.getElementById("text-close-btn"),i=document.getElementById("text-submit-btn");e&&(e.onclick=()=>{this.currentView="profile",this.renderCurrentView()}),o&&(o.onclick=()=>{this.currentView="profile",this.renderCurrentView()}),i&&(i.onclick=async()=>{await this.submitTextRequest()},i.onmouseover=()=>{i.style.background=this.lightenColor(this.appearance.primaryColor,10)},i.onmouseout=()=>{i.style.background=this.appearance.primaryColor})}async submitTextRequest(){var f,E,w,N,F,L,R,_,H,O,V,P,j,W,q,U;const e=document.getElementById("text-submit-btn"),o=document.getElementById("text-error"),i=(E=(f=document.getElementById("text-first-name"))==null?void 0:f.value)==null?void 0:E.trim(),t=(N=(w=document.getElementById("text-last-name"))==null?void 0:w.value)==null?void 0:N.trim(),n=(L=(F=document.getElementById("text-phone"))==null?void 0:F.value)==null?void 0:L.trim(),s=document.getElementById("text-email"),r=((R=s==null?void 0:s.value)==null?void 0:R.trim())||"",l=(H=(_=document.getElementById("text-message"))==null?void 0:_.value)==null?void 0:H.trim(),a=((O=this.textConfig)==null?void 0:O.fields)||{},c=((V=a.firstName)==null?void 0:V.required)!==!1,g=((P=a.lastName)==null?void 0:P.required)!==!1,b=((j=a.phone)==null?void 0:j.required)!==!1,d=((W=a.email)==null?void 0:W.enabled)!==!1,u=((q=a.email)==null?void 0:q.required)===!0,m=((U=a.message)==null?void 0:U.required)!==!1,y=[];if(c&&!i&&y.push("First name is required"),g&&!t&&y.push("Last name is required"),b&&!n&&y.push("Phone number is required"),d&&u&&!r&&y.push("Email is required"),d&&r&&(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r)||y.push("Please enter a valid email address")),m&&!l&&y.push("Message is required"),y.length>0){o&&(o.textContent=y[0],o.style.display="block");return}this.textData={firstName:i,lastName:t,email:r,phone:n,message:l},e&&(e.disabled=!0,e.textContent="Sending...");try{const k=await fetch(`${this.config.apiUrl}/api/public/chatbots/${this.config.chatbotId}/text-requests`,{method:"POST",headers:{"Content-Type":"application/json","ngrok-skip-browser-warning":"true"},body:JSON.stringify({sessionId:this.sessionId||this.generateId(),firstName:i,lastName:t,email:r||void 0,phone:n,message:l})});if(!k.ok){const ne=await k.json().catch(()=>({}));throw new Error(ne.error||"Failed to submit text request")}this.showTextSuccess()}catch(k){console.error("Text request submission error:",k),o&&(o.textContent=k.message||"Failed to send message. Please try again.",o.style.display="block"),e&&(e.disabled=!1,e.textContent="Send Message")}}showTextSuccess(){const e=document.getElementById("lbs-chat-content");if(!e)return;e.innerHTML=`
        <div style="display: flex; flex-direction: column; height: 100%; background: white; align-items: center; justify-content: center; padding: 24px; text-align: center;">
          <div style="width: 80px; height: 80px; background: #d1fae5; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 24px;">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="3">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>
          <h2 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 600; color: #111827;">Message Sent!</h2>
          <p style="margin: 0 0 24px 0; font-size: 15px; color: #6b7280; line-height: 1.5;">
            Thank you for reaching out. We'll get back to you as soon as possible.
          </p>
          <div style="background: #f9fafb; border-radius: 12px; padding: 20px; width: 100%; max-width: 300px; text-align: left;">
            <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">
              <strong style="color: #111827;">${h(this.textData.firstName)} ${h(this.textData.lastName)}</strong>
            </div>
            <div style="font-size: 14px; color: #6b7280;">
              ${h(this.textData.phone)}
            </div>
          </div>
          <button id="text-done-btn" style="
            margin-top: 24px;
            padding: 12px 32px;
            background: ${this.appearance.primaryColor};
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
          ">
            Done
          </button>
        </div>
      `;const o=document.getElementById("text-done-btn");o&&(o.onclick=()=>{this.currentView="profile",this.renderCurrentView()})}attachChatEventListeners(){const e=document.getElementById("lbs-back-btn"),o=document.getElementById("lbs-history-btn"),i=document.getElementById("lbs-expand-btn"),t=document.getElementById("lbs-fullscreen-minimize-btn"),n=document.getElementById("lbs-chat-new"),s=document.getElementById("lbs-chat-send-mic"),r=document.getElementById("lbs-chat-input"),l=document.getElementById("lbs-file-button"),a=document.getElementById("lbs-file-input"),c=document.getElementById("lbs-chat-window"),g=document.getElementById("lbs-menu-button"),b=document.getElementById("lbs-sidebar-overlay");if(e&&(e.onclick=()=>{this.currentView="profile",this.renderCurrentView()}),o&&(o.onclick=()=>this.toggleSidebar()),b&&(b.onclick=()=>this.toggleSidebar()),i&&(i.onclick=()=>this.toggleFullscreen()),t&&(t.onclick=()=>this.toggleFullscreen()),n&&(n.onclick=()=>this.startNewConversation()),s&&(s.onclick=()=>{const d=document.getElementById("lbs-chat-input"),u=d&&(d.value.trim()||this.pendingFiles.length>0);this.isRecording?this.stopVoiceRecording():u?this.sendMessage():this.startVoiceRecording()}),r){r.oninput=()=>{this.autoResizeTextarea(),this.updateSendMicIcon()};const d=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||"ontouchstart"in window&&window.innerWidth<768;r.onkeydown=u=>{if(u.key==="Enter"){if(d||u.shiftKey){setTimeout(()=>this.autoResizeTextarea(),0);return}u.preventDefault(),this.sendMessage()}}}l&&a&&(l.onclick=()=>{this.pendingFiles.length<5&&a.click()},l.onmouseover=()=>{l.style.background="#f3f4f6"},l.onmouseout=()=>{l.style.background="none"},a.onchange=d=>{const u=d.target.files;u&&u.length>0&&this.handleFilesSelected(Array.from(u)),a.value=""}),s&&(s.onmouseover=()=>{r.value.trim()||this.pendingFiles.length>0?s.style.opacity="0.9":s.style.background="#f3f4f6"},s.onmouseout=()=>{r.value.trim()||this.pendingFiles.length>0?s.style.opacity="1":s.style.background="none"}),g&&(g.onclick=()=>this.showActionCenter()),g&&(g.onmouseover=()=>{g.style.background="#f3f4f6"},g.onmouseout=()=>{g.style.background="none"}),c&&(c.ondragenter=d=>{d.preventDefault(),d.stopPropagation(),this.dragCounter++,this.dragCounter===1&&this.showDragOverlay()},c.ondragleave=d=>{d.preventDefault(),d.stopPropagation(),this.dragCounter--,this.dragCounter===0&&this.hideDragOverlay()},c.ondragover=d=>{d.preventDefault(),d.stopPropagation()},c.ondrop=d=>{var m;d.preventDefault(),d.stopPropagation(),this.dragCounter=0,this.hideDragOverlay();const u=(m=d.dataTransfer)==null?void 0:m.files;u&&u.length>0&&this.handleFilesSelected(Array.from(u))})}lightenColor(e,o){const i=parseInt(e.replace("#",""),16),t=Math.round(2.55*o),n=(i>>16)+t,s=(i>>8&255)+t,r=(i&255)+t;return"#"+(16777216+(n<255?n<1?0:n:255)*65536+(s<255?s<1?0:s:255)*256+(r<255?r<1?0:r:255)).toString(16).slice(1)}toggleChat(){this.isOpen=!this.isOpen;const e=document.getElementById("lbs-chat-window");e&&(e.style.display=this.isOpen?"flex":"none"),this.isOpen&&(this.renderCurrentView(),this.messages.length>0&&(this.currentView="chat",this.renderCurrentView()))}toggleFullscreen(){this.isFullscreen=!this.isFullscreen;const e=document.getElementById("lbs-chat-window");if(!e)return;const o=this.config.position.includes("right"),i=this.hasMultipleActions();if(this.isFullscreen)e.style.width="100vw",e.style.height="100vh",e.style.maxHeight="100vh",e.style.top="0px",e.style.bottom="0px",e.style.left="0px",e.style.right="0px",e.style.borderRadius="0";else{e.style.width="400px",e.style.height="650px",e.style.maxHeight="calc(100vh - 140px)";const n=i?`${(i?64:0)+8}px`:"100px";o?(e.style.top=`calc(100vh - 650px - ${n})`,e.style.left="calc(100vw - 400px - 20px)",e.style.right="20px",e.style.bottom=n):(e.style.top=`calc(100vh - 650px - ${n})`,e.style.left="20px",e.style.right="calc(100vw - 400px - 20px)",e.style.bottom=n),e.style.borderRadius="16px"}this.updateFullscreenIcons()}updateFullscreenIcons(){const e=document.getElementById("lbs-expand-btn"),o=document.getElementById("lbs-fullscreen-minimize-btn");e&&(e.style.display=this.isFullscreen?"none":"block"),o&&(o.style.display=this.isFullscreen?"block":"none")}renderStoredMessages(){if(this.messages.length>0)for(const e of this.messages)e.role==="user"&&e.attachments&&e.attachments.length>0?this.renderUserMessageWithFiles(e.content,e.attachments):this.renderMessage(e.role,e.content)}async handleFilesSelected(e){this.clearFileError();const o=5-this.pendingFiles.length,i=e.length>o?e.slice(0,o):e;e.length>o&&this.showFileError(`Maximum 5 files allowed. You can add ${o} more.`);for(const t of i){const n=J(t);if(!n.valid){this.showFileError(n.error);continue}try{const s=await Q(t);this.pendingFiles.push({name:t.name,mimeType:t.type,size:t.size,base64:s})}catch(s){this.showFileError(`Failed to read file: ${t.name}`)}}this.renderPendingFiles(),this.updateSendMicIcon()}removeFile(e){this.pendingFiles.splice(e,1),this.clearFileError(),this.renderPendingFiles(),this.updateSendMicIcon()}renderPendingFiles(){const e=document.getElementById("lbs-pending-files");if(!e)return;if(this.pendingFiles.length===0){e.style.display="none",e.innerHTML="";return}e.style.display="block",e.innerHTML=`
        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px;">
          ${this.pendingFiles.map((i,t)=>`
            <div style="display: flex; align-items: center; gap: 4px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 4px 8px; font-size: 12px;">
              <span>${T(i.mimeType)}</span>
              <div style="display: flex; flex-direction: column; min-width: 0;">
                <span style="font-weight: 500; color: #374151; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${h(i.name)}</span>
                <span style="color: #9ca3af; font-size: 10px;">${B(i.size)}</span>
              </div>
              <button
                data-file-index="${t}"
                style="background: none; border: none; cursor: pointer; color: #9ca3af; padding: 2px; display: flex; align-items: center;"
                title="Remove file"
              >
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
          `).join("")}
        </div>
      `,e.querySelectorAll("[data-file-index]").forEach(i=>{i.onclick=()=>{const t=parseInt(i.getAttribute("data-file-index"),10);this.removeFile(t)},i.onmouseover=()=>{i.style.color="#ef4444"},i.onmouseout=()=>{i.style.color="#9ca3af"}});const o=document.getElementById("lbs-file-button");o&&(this.pendingFiles.length>=5?(o.style.opacity="0.5",o.style.cursor="not-allowed"):(o.style.opacity="1",o.style.cursor="pointer"))}showFileError(e){this.fileError=e;const o=document.getElementById("lbs-file-error");o&&(o.textContent=e,o.style.display="block")}clearFileError(){this.fileError=null;const e=document.getElementById("lbs-file-error");e&&(e.style.display="none",e.textContent="")}autoResizeTextarea(){const e=document.getElementById("lbs-chat-input");if(!e)return;e.style.height="auto";const o=Math.min(Math.max(e.scrollHeight,40),112);e.style.height=o+"px"}resetTextareaHeight(){const e=document.getElementById("lbs-chat-input");e&&(e.style.height="40px")}updateSendMicIcon(){const e=document.getElementById("lbs-chat-input"),o=document.getElementById("lbs-mic-icon"),i=document.getElementById("lbs-send-icon"),t=document.getElementById("lbs-chat-send-mic");if(!e||!o||!i||!t)return;e.value.trim()||this.pendingFiles.length>0?(o.style.display="none",i.style.display="block",t.style.background=this.appearance.accentColor,t.style.color="white"):(o.style.display="block",i.style.display="none",t.style.background="none",t.style.color="#6b7280")}showDragOverlay(){const e=document.getElementById("lbs-drag-overlay");e&&(e.style.display="flex")}hideDragOverlay(){const e=document.getElementById("lbs-drag-overlay");e&&(e.style.display="none")}renderMessage(e,o){const i=document.getElementById("lbs-chat-messages");if(!i)return;const t=document.createElement("div");if(t.style.cssText=`
        margin-bottom: 12px;
        display: flex;
        ${e==="user"?"justify-content: flex-end;":"justify-content: flex-start;"}
      `,e==="assistant"){const n=document.createElement("div");n.className="widget-message-wrapper",n.style.cssText=`
          position: relative;
          max-width: 80%;
        `;const s=document.createElement("div");s.className=`widget-bubble widget-bubble-${e}`,s.style.cssText=`
          padding: 10px 14px;
          border-radius: 12px;
          font-size: 14px;
          line-height: 1.6;
          background: white;
          color: #1f2937;
          border: 1px solid #e5e7eb;
        `,s.innerHTML=$(o);const r=document.createElement("button");r.className="widget-copy-button",r.setAttribute("aria-label","Copy message"),r.innerHTML=`
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
        `,r.onclick=()=>{const l=document.createElement("div");l.innerHTML=s.innerHTML;const a=l.textContent||l.innerText||"";navigator.clipboard.writeText(a).then(()=>{const c=r.innerHTML;r.innerHTML=`
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            `,setTimeout(()=>{r.innerHTML=c},2e3)}).catch(c=>{console.error("Failed to copy text:",c)})},n.appendChild(s),n.appendChild(r),t.appendChild(n)}else{const n=document.createElement("div");n.className=`widget-bubble widget-bubble-${e}`,n.style.cssText=`
          max-width: 80%;
          padding: 10px 14px;
          border-radius: 12px;
          font-size: 14px;
          line-height: 1.6;
          background: ${this.appearance.accentColor};
          color: white;
          white-space: pre-wrap;
          word-wrap: break-word;
        `,n.textContent=o,t.appendChild(n)}i.appendChild(t),i.scrollTop=i.scrollHeight}async sendMessage(){var b;const e=document.getElementById("lbs-chat-input"),o=e&&e.value.trim(),i=this.pendingFiles.length>0;if(!o&&!i||this.isLoading)return;const t=e?e.value.trim():"";e&&(e.value="",this.resetTextareaHeight());const n=[...this.pendingFiles];this.pendingFiles=[],this.renderPendingFiles(),this.clearFileError(),this.updateSendMicIcon(),n.length>0?this.renderUserMessageWithFiles(t,n):this.renderMessage("user",t);const r={role:"user",content:t||(n.length>0?`[Attached: ${n.map(d=>d.name).join(", ")}]`:"")};n.length>0&&(r.attachments=n.map(d=>({name:d.name,mimeType:d.mimeType,size:d.size}))),this.messages.push(r),this.saveSession(),this.isLoading=!0;const l=K(),a=this.createThinkingMessage(l),c=this.isNewSession&&this.messages.length===1,g=n.length>0?n.map(d=>({name:d.name,mimeType:d.mimeType,size:d.size,base64:d.base64})):void 0;try{const d=await fetch(`${this.config.apiUrl}/api/public/chat/${this.config.chatbotId}`,{method:"POST",headers:{"Content-Type":"application/json","ngrok-skip-browser-warning":"true"},body:JSON.stringify({message:t,sessionId:this.sessionId,isNewSession:c,conversationHistory:this.getConversationHistory().slice(0,-1),files:g})});if(!d.ok)throw new Error("Failed to send message");c&&(this.isNewSession=!1);const u=d.headers.get("content-type");if(u!=null&&u.includes("text/event-stream"))await this.handleSSEStream(d,a);else{const m=await d.json();if(m.success&&((b=m.data)!=null&&b.message))a!=null&&a.parentElement&&a.parentElement.remove(),this.addMessage("assistant",m.data.message);else if(m.error)throw new Error(m.error)}}catch(d){console.error("Failed to send message:",d),a!=null&&a.parentElement&&a.parentElement.remove(),this.addMessage("assistant","Sorry, I'm having trouble responding right now. Please try again.")}finally{this.isLoading=!1}}renderUserMessageWithFiles(e,o){const i=document.getElementById("lbs-chat-messages");if(!i)return;const t=document.createElement("div");t.style.cssText=`
        margin-bottom: 12px;
        display: flex;
        justify-content: flex-end;
      `;const n=document.createElement("div");n.className="widget-bubble widget-bubble-user",n.style.cssText=`
        max-width: 80%;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 14px;
        line-height: 1.6;
        background: ${this.appearance.accentColor};
        color: white;
        white-space: pre-wrap;
        word-wrap: break-word;
      `;let s="";if(o&&o.length>0){s+=`<div style="margin-bottom: ${e?"8px":"0"}; display: flex; flex-direction: column; gap: 4px;">`;for(const r of o)s+=`
            <div style="display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.2); border-radius: 6px; padding: 4px 8px; font-size: 12px;">
              <span>${T(r.mimeType)}</span>
              <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 150px;">${h(r.name)}</span>
              <span style="opacity: 0.8; font-size: 10px;">(${B(r.size)})</span>
            </div>
          `;s+="</div>"}e&&!e.startsWith("[Attached:")&&(s+=h(e)),n.innerHTML=s,t.appendChild(n),i.appendChild(t),i.scrollTop=i.scrollHeight}addMessage(e,o){this.messages.push({role:e,content:o}),this.saveSession(),this.renderMessage(e,o)}getConversationHistory(){return this.messages.map(e=>({role:e.role,content:e.content}))}async handleSSEStream(e,o){var a,c,g,b;const i=(a=e.body)==null?void 0:a.getReader();if(!i)throw new Error("No response body");const t=new TextDecoder;let n="",s="",r=null,l=o;try{for(;;){const{done:d,value:u}=await i.read();if(d)break;n+=t.decode(u,{stream:!0});const m=n.split(`
`);n=m.pop()||"";for(const y of m)if(y.startsWith("data: "))try{const f=JSON.parse(y.slice(6));switch(f.type){case"start":break;case"content":f.content&&(s+=f.content,l&&(l.classList.remove("widget-thinking"),l.style.color="#1f2937",l.style.fontStyle="normal"),this.updateStreamingMessage(l,s));break;case"tool_call":console.log("[Widget] Tool call received:",f.toolCall),((c=f.toolCall)==null?void 0:c.name)==="show_lead_form"?(r=f.toolCall,l!=null&&l.parentElement&&(l.parentElement.remove(),l=null),this.showLeadForm(f.toolCall.parameters,f.toolCall.isContactCapture)):((g=f.toolCall)==null?void 0:g.name)==="show_booking_trigger"&&(r=f.toolCall,f.toolCall.calendlyLink?(console.log("[Widget] Opening Calendly:",f.toolCall.calendlyLink),window.open(f.toolCall.calendlyLink,"_blank")):f.toolCall.isContactCapture&&(l!=null&&l.parentElement&&(l.parentElement.remove(),l=null),this.showLeadForm(f.toolCall.parameters,!0)));break;case"complete":const E=f.content||s;this.updateStreamingMessage(l,E),this.messages.push({role:"assistant",content:E}),this.saveSession();break;case"error":const w=((b=f.error)==null?void 0:b.message)||"An error occurred. Please try again.";l?this.updateStreamingMessage(l,w):this.renderMessage("assistant",w),this.messages.push({role:"assistant",content:w}),this.saveSession();break}}catch(f){}}if(l&&!s&&!r){const d="Sorry, I'm having trouble responding right now. Please try again.";this.updateStreamingMessage(l,d),this.messages.push({role:"assistant",content:d}),this.saveSession()}}finally{i.releaseLock()}}updateStreamingMessage(e,o){if(!e)return;e.innerHTML=$(o);const i=document.getElementById("lbs-chat-messages");i&&(i.scrollTop=i.scrollHeight)}createThinkingMessage(e){const o=document.getElementById("lbs-chat-messages");if(!o)return null;const i=document.createElement("div");i.style.cssText=`
        margin-bottom: 12px;
        display: flex;
        justify-content: flex-start;
      `;const t=document.createElement("div");return t.className="widget-bubble widget-bubble-assistant widget-thinking",t.style.cssText=`
        max-width: 80%;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 14px;
        line-height: 1.6;
        background: white;
        color: #6b7280;
        border: 1px solid #e5e7eb;
        font-style: italic;
      `,t.textContent=e,i.appendChild(t),o.appendChild(i),o.scrollTop=o.scrollHeight,t}showLeadForm(e,o=!1){const i=document.getElementById("lbs-chat-messages");if(!i||document.getElementById("widget-lead-form"))return;this.isContactCaptureMode=o;const t=e.extractedData||{},n=this.appearance.primaryColor,s=o?"Schedule a Call":"Connect with an Attorney",r=o?"Please provide your contact information and we'll reach out to schedule a time.":"Please provide your contact information and we'll connect you with an experienced attorney.",l=o?"":`
            <div>
              <label style="display: block; font-size: 11px; font-weight: 500; color: #4b5563; margin-bottom: 4px;">
                Type of Legal Matter <span style="color: #9ca3af;">(optional)</span>
              </label>
              <input
                type="text"
                name="caseType"
                value="${h(t.caseType||"")}"
                placeholder="e.g., Family Law, Custody, etc."
                style="width: 100%; padding: 8px 12px; font-size: 13px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box;"
              />
            </div>

            <div>
              <label style="display: block; font-size: 11px; font-weight: 500; color: #4b5563; margin-bottom: 4px;">
                How soon do you need assistance? <span style="color: #9ca3af;">(optional)</span>
              </label>
              <select
                name="urgency"
                style="width: 100%; padding: 8px 12px; font-size: 13px; border: 1px solid #d1d5db; border-radius: 6px; background: white; box-sizing: border-box;"
              >
                <option value="">Select urgency</option>
                <option value="IMMEDIATE" ${t.urgency==="IMMEDIATE"?"selected":""}>Immediate</option>
                <option value="THIS_WEEK" ${t.urgency==="THIS_WEEK"?"selected":""}>This Week</option>
                <option value="THIS_MONTH" ${t.urgency==="THIS_MONTH"?"selected":""}>This Month</option>
                <option value="EXPLORING" ${t.urgency==="EXPLORING"?"selected":""}>Just Exploring</option>
              </select>
            </div>`,a=document.createElement("div");a.id="widget-lead-form",a.style.cssText=`
        margin-bottom: 12px;
        display: flex;
        justify-content: flex-start;
      `,a.innerHTML=`
        <div style="max-width: 90%; background: #f0fdf4; border: 1px solid ${n}; border-radius: 12px; padding: 16px;">
          <div style="margin-bottom: 12px;">
            <h3 style="font-size: 14px; font-weight: 600; color: #166534; margin: 0 0 4px 0;">
              ${s}
            </h3>
            <p style="font-size: 12px; color: #4b5563; margin: 0;">
              ${r}
            </p>
          </div>

          <form id="widget-lead-form-element" style="display: flex; flex-direction: column; gap: 10px;">
            <div>
              <label style="display: block; font-size: 11px; font-weight: 500; color: #4b5563; margin-bottom: 4px;">
                Name <span style="color: #ef4444;">*</span>
              </label>
              <input
                type="text"
                name="name"
                value="${h(t.name||"")}"
                placeholder="Your full name"
                required
                style="width: 100%; padding: 8px 12px; font-size: 13px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box;"
              />
            </div>

            <div>
              <label style="display: block; font-size: 11px; font-weight: 500; color: #4b5563; margin-bottom: 4px;">
                Email <span style="color: #ef4444;">*</span>
              </label>
              <input
                type="email"
                name="email"
                value="${h(t.email||"")}"
                placeholder="your@email.com"
                required
                style="width: 100%; padding: 8px 12px; font-size: 13px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box;"
              />
            </div>

            <div>
              <label style="display: block; font-size: 11px; font-weight: 500; color: #4b5563; margin-bottom: 4px;">
                Phone <span style="color: #ef4444;">*</span>
              </label>
              <input
                type="tel"
                name="phone"
                value="${h(t.phone||"")}"
                placeholder="(555) 123-4567"
                required
                style="width: 100%; padding: 8px 12px; font-size: 13px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box;"
              />
            </div>
${l}
            <div id="widget-lead-form-error" style="display: none; background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 8px; font-size: 12px; color: #991b1b;"></div>

            <div style="display: flex; gap: 8px; margin-top: 4px;">
              <button
                type="submit"
                id="widget-lead-submit-btn"
                style="flex: 1; padding: 10px 16px; background: ${n}; color: white; font-size: 13px; font-weight: 500; border: none; border-radius: 6px; cursor: pointer;"
              >
                Submit
              </button>
              <button
                type="button"
                id="widget-lead-cancel-btn"
                style="padding: 10px 16px; background: #e5e7eb; color: #374151; font-size: 13px; font-weight: 500; border: none; border-radius: 6px; cursor: pointer;"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      `,i.appendChild(a),i.scrollTop=i.scrollHeight;const c=document.getElementById("widget-lead-form-element"),g=document.getElementById("widget-lead-cancel-btn");c&&(c.onsubmit=b=>{b.preventDefault(),this.submitLeadForm(c)}),g&&(g.onclick=()=>{a.remove(),this.renderMessage("assistant","No problem! Let me know if you'd like to connect with an attorney later.")})}async submitLeadForm(e){var c,g,b,d,u;const o=new FormData(e),i=document.getElementById("widget-lead-submit-btn"),t=document.getElementById("widget-lead-form-error"),n=document.getElementById("widget-lead-form"),s=(c=o.get("name"))==null?void 0:c.toString().trim(),r=(g=o.get("email"))==null?void 0:g.toString().trim();if(!s||!r){t&&(t.textContent="Please fill in all required fields.",t.style.display="block");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r)){t&&(t.textContent="Please enter a valid email address.",t.style.display="block");return}i&&(i.disabled=!0,i.textContent="Submitting...");const l={name:s,email:r,phone:((b=o.get("phone"))==null?void 0:b.toString().trim())||void 0,caseType:((d=o.get("caseType"))==null?void 0:d.toString().trim())||void 0,urgency:((u=o.get("urgency"))==null?void 0:u.toString())||void 0},a=Array.isArray(this.messages)&&this.messages.length>0?{messages:this.messages.filter(m=>m&&m.role&&m.content).map(m=>({role:m.role.toUpperCase(),content:m.content,createdAt:m.createdAt||new Date().toISOString(),localId:m.localId})),capturedAt:new Date().toISOString(),sessionId:this.sessionId}:null;try{if(!(await fetch(`${this.config.apiUrl}/api/public/chat/${this.config.chatbotId}/lead`,{method:"POST",headers:{"Content-Type":"application/json","ngrok-skip-browser-warning":"true"},body:JSON.stringify({...l,sessionId:this.sessionId,source:this.isContactCaptureMode?"BOOKING_FALLBACK":"LEAD_FORM",...a&&{conversationSnapshot:a}})})).ok)throw new Error("Failed to submit lead");n&&n.remove(),this.renderMessage("assistant","Thank you! Your information has been submitted. An attorney will reach out to you soon."),this.messages.push({role:"assistant",content:"Thank you! Your information has been submitted. An attorney will reach out to you soon."}),this.saveSession()}catch(m){console.error("[Widget] Lead submission error:",m),t&&(t.textContent="Failed to submit your information. Please try again.",t.style.display="block"),i&&(i.disabled=!1,i.textContent="Submit")}}showActionCenter(){if(document.getElementById("widget-action-center")){const r=document.getElementById("widget-action-center-overlay");r&&r.remove();return}const o=document.getElementById("lbs-chat-window");if(!o)return;const i=document.createElement("div");i.id="widget-action-center-overlay",i.style.cssText=`
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 16px;
      `;const t=document.createElement("div");t.id="widget-action-center",t.style.cssText=`
        background: white;
        border-radius: 16px;
        padding: 24px;
        max-width: 340px;
        width: 90%;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      `,t.innerHTML=`
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="font-size: 20px; font-weight: 600; color: #111827; margin: 0;">Action Center</h2>
          <button id="widget-action-center-close" style="background: none; border: none; cursor: pointer; color: #6b7280; padding: 4px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>

        <h3 style="font-size: 14px; font-weight: 500; color: #6b7280; margin: 0 0 12px 0;">Actions</h3>

        <button id="widget-feedback-btn" style="
          width: 100%;
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 16px;
          background: white;
          border: 1px solid #e5e7eb;
          border-radius: 12px;
          cursor: pointer;
          margin-bottom: 12px;
          transition: all 0.2s;
        ">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="
              width: 40px;
              height: 40px;
              border-radius: 50%;
              background: #9ca3af;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
            ">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
              </svg>
            </div>
            <span style="font-size: 16px; color: #374151; font-weight: 500;">Give feedback</span>
          </div>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
      `,i.appendChild(t),o.appendChild(i);const n=document.getElementById("widget-action-center-close"),s=document.getElementById("widget-feedback-btn");n&&(n.onclick=()=>i.remove()),s&&(s.onclick=()=>{i.remove(),this.showFeedbackForm()},s.onmouseover=()=>{s.style.background="#f9fafb",s.style.borderColor=this.appearance.accentColor},s.onmouseout=()=>{s.style.background="white",s.style.borderColor="#e5e7eb"}),i.onclick=r=>{r.target===i&&i.remove()}}showFeedbackForm(){const e=document.getElementById("widget-feedback-form-overlay");if(e){e.remove();return}const o=document.getElementById("lbs-chat-window");if(!o)return;const i=document.createElement("div");i.id="widget-feedback-form-overlay",i.style.cssText=`
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 16px;
      `;const t=document.createElement("div");t.id="widget-feedback-form",t.style.cssText=`
        background: white;
        border-radius: 16px;
        padding: 24px;
        max-width: 340px;
        width: 90%;
        max-height: 80%;
        overflow-y: auto;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      `,t.innerHTML=`
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2 style="font-size: 20px; font-weight: 600; color: #111827; margin: 0;">User Feedback</h2>
          <button id="widget-feedback-close" style="background: none; border: none; cursor: pointer; color: #6b7280; padding: 4px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>

        <p style="color: #6b7280; font-size: 14px; margin: 0 0 24px 0; line-height: 1.6;">
          If you're experiencing any problems or have suggestions for improvement,
          please share your thoughts with us. The more specific information you provide,
          the better we can help.
        </p>

        <form id="widget-feedback-form-element">
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 14px; font-weight: 600; color: #111827; margin-bottom: 8px;">
              Subject
            </label>
            <input
              type="text"
              id="feedback-subject"
              name="subject"
              required
              style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;"
            />
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 14px; font-weight: 600; color: #111827; margin-bottom: 8px;">
              Content
            </label>
            <textarea
              id="feedback-content"
              name="content"
              required
              maxlength="1000"
              rows="6"
              style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; resize: vertical; box-sizing: border-box;"
            ></textarea>
            <div style="text-align: right; margin-top: 4px; font-size: 12px; color: #6b7280;">
              <span id="feedback-char-count">0</span>/1000
            </div>
          </div>

          <div id="feedback-error" style="display: none; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px; margin-bottom: 16px; color: #991b1b; font-size: 14px;"></div>

          <div style="display: flex; justify-content: flex-end;">
            <button
              type="submit"
              id="feedback-submit-btn"
              style="
                padding: 10px 24px;
                background: ${this.appearance.accentColor};
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: opacity 0.2s;
              "
            >
              Confirm
            </button>
          </div>
        </form>
      `,i.appendChild(t),o.appendChild(i);const n=document.getElementById("feedback-content"),s=document.getElementById("feedback-char-count");n&&s&&(n.oninput=()=>{s.textContent=n.value.length});const r=document.getElementById("widget-feedback-form-element");r&&(r.onsubmit=a=>{a.preventDefault(),this.submitFeedback(r)});const l=document.getElementById("widget-feedback-close");l&&(l.onclick=()=>i.remove()),i.onclick=a=>{a.target===i&&i.remove()}}async submitFeedback(e){var r,l;const o=new FormData(e),i=document.getElementById("feedback-submit-btn"),t=document.getElementById("feedback-error"),n=(r=o.get("subject"))==null?void 0:r.toString().trim(),s=(l=o.get("content"))==null?void 0:l.toString().trim();if(!n||!s){t&&(t.textContent="Please fill in all fields.",t.style.display="block");return}i&&(i.disabled=!0,i.textContent="Submitting...");try{if(!(await fetch(`${this.config.apiUrl}/api/public/chat/${this.config.chatbotId}/feedback`,{method:"POST",headers:{"Content-Type":"application/json","ngrok-skip-browser-warning":"true"},body:JSON.stringify({sessionId:this.sessionId,subject:n,content:s})})).ok)throw new Error("Failed to submit feedback");const c=document.getElementById("widget-feedback-form-overlay");c&&c.remove(),this.renderMessage("assistant","Thank you for your feedback! We appreciate you taking the time to help us improve.")}catch(a){console.error("[Widget] Feedback submission error:",a),t&&(t.textContent="Failed to submit feedback. Please try again.",t.style.display="block"),i&&(i.disabled=!1,i.textContent="Confirm")}}async startVoiceRecording(){try{const e=document.getElementById("lbs-chat-input");e&&(this.finalTranscript=e.value);const o=await fetch(`${this.config.apiUrl}/api/public/deepgram/token`);if(!o.ok)throw new Error("Failed to get voice service token");const{token:i}=await o.json();this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),this.showVoiceModal(),await this.connectToDeepgram(i),this.isRecording=!0,this.updateSendMicIcon()}catch(e){console.error("Error starting voice recording:",e),this.cleanupVoiceRecording(),e.name==="NotAllowedError"?M("Microphone access was denied. Please allow microphone access to use voice recording.","error"):M("Failed to start voice recording. Please try again.","error")}}stopVoiceRecording(){this.isRecording=!1;const e=document.getElementById("lbs-chat-input");e&&this.finalTranscript&&(e.value=this.finalTranscript,this.autoResizeTextarea()),this.cleanupVoiceRecording(),this.closeVoiceModal(),this.updateSendMicIcon()}async connectToDeepgram(e){return new Promise((o,i)=>{const t=new URL("wss://api.deepgram.com/v1/listen");t.searchParams.append("model","nova-2"),t.searchParams.append("smart_format","true"),t.searchParams.append("interim_results","true"),t.searchParams.append("punctuate","true"),t.searchParams.append("vad_events","true"),this.deepgramSocket=new WebSocket(t.toString(),["token",e]),this.deepgramSocket.onopen=()=>{console.log("[Widget] Deepgram WebSocket connected");let n="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(n)||(n="audio/webm"),this.mediaRecorder=new MediaRecorder(this.mediaStream,{mimeType:n}),this.mediaRecorder.ondataavailable=s=>{s.data.size>0&&this.deepgramSocket&&this.deepgramSocket.readyState===WebSocket.OPEN&&this.deepgramSocket.send(s.data)},this.mediaRecorder.start(250),this.initAudioVisualizer(),o()},this.deepgramSocket.onmessage=n=>{var s,r,l;try{const a=JSON.parse(n.data);if(a.type==="Results"){const c=((l=(r=(s=a.channel)==null?void 0:s.alternatives)==null?void 0:r[0])==null?void 0:l.transcript)||"",g=a.is_final||!1;c&&(g?(this.finalTranscript=this.finalTranscript?`${this.finalTranscript} ${c}`:c,this.interimTranscript=""):this.interimTranscript=c,this.updateVoiceModalTranscript())}}catch(a){console.error("[Widget] Error parsing Deepgram message:",a)}},this.deepgramSocket.onerror=n=>{console.error("[Widget] Deepgram WebSocket error:",n),i(new Error("WebSocket connection error"))},this.deepgramSocket.onclose=n=>{n.code!==1e3&&console.error("[Widget] Deepgram WebSocket closed abnormally:",n)}})}initAudioVisualizer(){const e=document.getElementById("lbs-voice-visualizer");if(!e||!this.mediaStream||typeof SiriWave=="undefined")return;const o=e.offsetWidth;this.siriWave=new SiriWave({container:e,width:o,height:120,speed:0,amplitude:0,autostart:!0,style:"ios",cover:!0,curveDefinition:[{attenuation:-2,lineWidth:1,opacity:.15,color:"rgb(200, 200, 200)"},{attenuation:-6,lineWidth:1,opacity:.25,color:"rgb(170, 170, 170)"},{attenuation:4,lineWidth:1.5,opacity:.4,color:"rgb(140, 140, 140)"},{attenuation:2,lineWidth:1.5,opacity:.6,color:"rgb(110, 110, 110)"},{attenuation:1,lineWidth:2,opacity:.8,color:"rgb(80, 80, 80)"}]}),this.audioContext=new(window.AudioContext||window.webkitAudioContext);const i=this.audioContext.createMediaStreamSource(this.mediaStream),t=this.audioContext.createScriptProcessor(1024,1,1),n=this.audioContext.createAnalyser();n.fftSize=4096;const s=new Float32Array(n.frequencyBinCount);i.connect(n),n.connect(t),t.connect(this.audioContext.destination),this.siriWave.start(),t.onaudioprocess=r=>{let l=0,a=0;n.getFloatFrequencyData(s),s.forEach((c,g)=>{c>C.FREQUENCY_THRESHOLD_DB&&(a=Math.max(g,a))}),a=(1+a)*C.FREQUENCY_SCALE_FACTOR/C.FREQUENCY_DIVISOR,a=a*C.FREQUENCY_SPEED_MULTIPLIER,this.siriWave.setSpeed(a),r.inputBuffer.getChannelData(0).forEach(c=>{l=Math.max(l,Math.abs(c))}),l=Math.abs(l*C.AMPLITUDE_SCALE),this.siriWave.setAmplitude(l)}}showVoiceModal(){if(document.getElementById("lbs-chat-window"))if(typeof SiriWave=="undefined"){const o=document.createElement("script");o.src="https://cdn.jsdelivr.net/npm/siriwave@2.4.0/dist/siriwave.umd.min.js",o.onload=()=>{this._createVoiceModal()},o.onerror=()=>{console.error("[Widget] Failed to load SiriWave library"),this._createVoiceModal()},document.head.appendChild(o)}else this._createVoiceModal()}_createVoiceModal(){const e=document.getElementById("lbs-chat-window");if(!e)return;const o=document.createElement("div");o.id="lbs-voice-modal-overlay",o.style.cssText=`
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
      `;const i=document.createElement("div");i.id="lbs-voice-modal",i.style.cssText=`
        background: white;
        border-radius: 16px;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      `,i.innerHTML=`
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; border-bottom: 1px solid #e5e7eb;">
          <h2 style="font-size: 18px; font-weight: 600; color: #111827; margin: 0;">Recording</h2>
          <button id="lbs-voice-done-btn" style="
            padding: 8px 16px;
            background: #111827;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
          ">Done</button>
        </div>
        <div style="padding: 32px 24px; display: flex; flex-direction: column; align-items: center;">
          <div id="lbs-voice-visualizer" style="width: 100%; height: 120px; margin-bottom: 32px;"></div>
          <div id="lbs-voice-transcript" style="
            width: 100%;
            min-height: 100px;
            text-align: center;
            font-size: 16px;
            line-height: 1.6;
            color: #111827;
          ">
            <p style="color: #9ca3af; font-style: italic; margin: 0;">Start speaking...</p>
          </div>
        </div>
      `,o.appendChild(i),e.appendChild(o);const t=document.getElementById("lbs-voice-done-btn");t&&(t.onclick=()=>this.stopVoiceRecording(),t.onmouseover=()=>{t.style.background="#1f2937"},t.onmouseout=()=>{t.style.background="#111827"}),o.onclick=s=>{s.target===o&&this.stopVoiceRecording()};const n=s=>{s.key==="Escape"&&(this.stopVoiceRecording(),document.removeEventListener("keydown",n))};document.addEventListener("keydown",n)}updateVoiceModalTranscript(){const e=document.getElementById("lbs-voice-transcript");if(!e)return;const o=this.interimTranscript?this.finalTranscript?`${this.finalTranscript} ${this.interimTranscript}`:this.interimTranscript:this.finalTranscript;if(o){const i=o.length>500?"..."+o.slice(-500):o;e.innerHTML=`<p style="margin: 0;">${i}</p>`}else e.innerHTML='<p style="color: #9ca3af; font-style: italic; margin: 0;">Start speaking...</p>'}closeVoiceModal(){const e=document.getElementById("lbs-voice-modal-overlay");e&&e.remove()}cleanupVoiceRecording(){this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop(),this.mediaRecorder=null,this.deepgramSocket&&(this.deepgramSocket.readyState===WebSocket.OPEN&&this.deepgramSocket.send(JSON.stringify({type:"CloseStream"})),this.deepgramSocket.close(),this.deepgramSocket=null),this.mediaStream&&(this.mediaStream.getTracks().forEach(e=>e.stop()),this.mediaStream=null),this.siriWave&&(this.siriWave.setAmplitude(0),this.siriWave.setSpeed(0),this.siriWave.dispose(),this.siriWave=null),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.interimTranscript=""}}window.LeadBotStudio={init:function(p){if(!p.chatbotId){console.error("chatbotId is required");return}new oe(p)}};const A=document.createElement("style");A.textContent=`
    /* Animations */
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
      }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .widget-thinking {
      animation: pulse 1.5s ease-in-out infinite;
    }

    /* Smooth transitions */
    #lbs-chat-content {
      transition: opacity 0.2s ease-in-out;
    }

    /* Suggested question hover effects */
    .suggested-question-btn:hover {
      background: #f9fafb;
      border-color: #3B82F6;
      transform: translateX(4px);
    }

    /* Scrollbar styling */
    #lbs-chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    #lbs-chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    #lbs-chat-messages::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    #lbs-chat-messages::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    /* Markdown styles */
    .widget-bubble {
      font-size: 14px;
      line-height: 1.5;
    }
    .widget-bubble > *:first-child {
      margin-top: 0 !important;
    }
    .widget-bubble > *:last-child {
      margin-bottom: 0 !important;
    }
    .widget-bubble p {
      margin: 0 0 0.5rem 0;
      line-height: 1.5;
    }
    .widget-bubble p:last-child {
      margin-bottom: 0;
    }
    .widget-bubble p + .widget-list,
    .widget-bubble p + .widget-list-ordered {
      margin-top: 0.125rem;
    }
    .widget-bubble strong {
      font-weight: 700;
    }
    .widget-bubble em {
      font-style: italic;
    }
    .widget-bubble del {
      text-decoration: line-through;
      opacity: 0.7;
    }

    /* Headings */
    .widget-heading {
      font-weight: 700;
      line-height: 1.3;
    }
    h1.widget-heading { font-size: 1.125rem; margin: 0.75rem 0 0.375rem; }
    h2.widget-heading { font-size: 1.0625rem; margin: 0.625rem 0 0.3125rem; }
    h3.widget-heading { font-size: 1rem; margin: 0.5rem 0 0.25rem; font-weight: 600; }
    h4.widget-heading,
    h5.widget-heading,
    h6.widget-heading { font-size: 0.9375rem; margin: 0.375rem 0 0.1875rem; font-weight: 600; }

    /* Inline code */
    .widget-inline-code {
      font-family: ui-monospace, 'Cascadia Code', 'Fira Code', 'Courier New', monospace;
      font-size: 0.8125em;
      padding: 0.1rem 0.3rem;
      border-radius: 0.25rem;
      background-color: #f1f5f9;
      color: #0f172a;
      border: 1px solid #e2e8f0;
      font-weight: 500;
    }

    /* Code blocks */
    .widget-code-block {
      margin: 0.5rem 0;
      padding: 0.625rem 0.75rem;
      border-radius: 0.375rem;
      overflow-x: auto;
      background-color: #f8fafc;
      border: 1px solid #e2e8f0;
      font-family: ui-monospace, 'Cascadia Code', 'Fira Code', 'Courier New', monospace;
      font-size: 0.8125rem;
      line-height: 1.45;
    }
    .widget-code-block code {
      font-family: inherit;
      font-size: inherit;
      background: none;
      border: none;
      padding: 0;
    }

    /* Links */
    .widget-link {
      color: #2563eb;
      text-decoration: underline;
      text-underline-offset: 2px;
      text-decoration-thickness: 1px;
      text-decoration-color: rgba(37, 99, 235, 0.3);
      font-weight: 500;
    }
    .widget-link:hover {
      color: #1d4ed8;
      text-decoration-color: rgba(29, 78, 216, 0.6);
    }

    /* Unordered lists */
    .widget-list {
      margin: 0.25rem 0 0.375rem;
      padding-left: 1.25rem;
      list-style-type: disc;
    }
    .widget-list .widget-list {
      list-style-type: circle;
      margin: 0.0625rem 0;
      padding-left: 1.125rem;
    }
    .widget-list .widget-list .widget-list {
      list-style-type: square;
    }

    /* Ordered lists */
    .widget-list-ordered {
      margin: 0.25rem 0 0.375rem;
      padding-left: 1.25rem;
      list-style-type: decimal;
    }
    .widget-list-ordered .widget-list-ordered {
      list-style-type: lower-alpha;
      margin: 0.0625rem 0;
      padding-left: 1.125rem;
    }

    /* List items */
    .widget-list-item,
    .widget-list-item-ordered {
      margin: 0.0625rem 0;
      padding-left: 0.125rem;
      line-height: 1.45;
      display: list-item;
    }
    .widget-list-item > p,
    .widget-list-item-ordered > p {
      margin: 0;
      display: inline;
    }

    /* Blockquotes */
    .widget-blockquote {
      margin: 0.5rem 0;
      padding: 0.375rem 0.625rem;
      border-left: 3px solid #3b82f6;
      background-color: rgba(59, 130, 246, 0.05);
      border-radius: 0 0.25rem 0.25rem 0;
      font-style: italic;
    }

    /* Horizontal rule */
    .widget-hr {
      margin: 0.625rem 0;
      border: 0;
      border-top: 1px solid rgba(0, 0, 0, 0.12);
    }

    /* Message hover effects and copy button */
    .widget-message-wrapper {
      position: relative;
    }

    .widget-copy-button {
      position: absolute;
      bottom: -8px;
      left: 8px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: white;
      border: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity 0.2s ease, transform 0.2s ease, background 0.2s ease, border-color 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 0;
      outline: none;
    }

    .widget-copy-button:hover {
      background: #f9fafb;
      border-color: #3B82F6;
    }

    .widget-copy-button:active {
      transform: translateY(4px) scale(0.95);
    }

    .widget-message-wrapper:hover .widget-copy-button {
      opacity: 1;
      transform: translateY(0);
    }

    .widget-copy-button svg {
      color: #6b7280;
      transition: color 0.2s ease;
    }

    .widget-copy-button:hover svg {
      color: #3B82F6;
    }

    /* Toast notifications (shadcn-style) */
    .lbs-toast {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
      pointer-events: auto;
      max-width: 420px;
      min-width: 300px;
      opacity: 0;
      transform: translateX(100%);
      transition: opacity 0.2s ease, transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .lbs-toast-visible {
      opacity: 1;
      transform: translateX(0);
    }

    .lbs-toast-hiding {
      opacity: 0;
      transform: translateX(100%);
    }

    .lbs-toast-icon {
      flex-shrink: 0;
      margin-top: 2px;
    }

    .lbs-toast-error .lbs-toast-icon {
      color: #ef4444;
    }

    .lbs-toast-success .lbs-toast-icon {
      color: #22c55e;
    }

    .lbs-toast-warning .lbs-toast-icon {
      color: #f59e0b;
    }

    .lbs-toast-info .lbs-toast-icon {
      color: #3b82f6;
    }

    .lbs-toast-content {
      flex: 1;
      min-width: 0;
    }

    .lbs-toast-message {
      margin: 0;
      font-size: 14px;
      line-height: 1.5;
      color: #1f2937;
      word-wrap: break-word;
    }

    .lbs-toast-close {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      padding: 0;
      margin: -4px -4px -4px 0;
      background: transparent;
      border: none;
      border-radius: 4px;
      color: #9ca3af;
      cursor: pointer;
      transition: background-color 0.15s ease, color 0.15s ease;
    }

    .lbs-toast-close:hover {
      background: #f3f4f6;
      color: #4b5563;
    }

    .lbs-toast-close:active {
      background: #e5e7eb;
    }
  `,document.head.appendChild(A)})();})();
